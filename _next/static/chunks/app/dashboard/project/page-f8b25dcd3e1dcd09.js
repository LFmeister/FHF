(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6],{7459:function(e,t,a){Promise.resolve().then(a.bind(a,4102))},4102:function(e,t,a){"use strict";a.r(t),a.d(t,{default:function(){return ProjectPageByQuery}});var s=a(7437),r=a(4033),l=a(2265),i=a(3067),n=a(2457),o=a(5790),c=a(5713),d=a(8884),m=a(9865),x=a(5750),u=a(9409),g=a(9883),h=a(6806),p=a(1018),f=a(1865),j=a(8110),b=a(1541),v=a(2549),y=a(7823);let N={async createIncome(e,t){let{data:{user:a}}=await y.O.auth.getUser();if(!a)throw Error("Usuario no autenticado");let{data:s,error:r}=await y.O.from("income").insert({project_id:e,user_id:a.id,description:t.description,amount:t.amount,category:t.category,income_date:t.income_date,status:"approved",performed_by:t.performed_by||a.id}).select("\n        *,\n        user:users!user_id (\n          full_name,\n          email\n        ),\n        performed_user:users!performed_by (\n          full_name,\n          email\n        )\n      ").single();if(r)throw r;return s},async getProjectIncome(e){let{data:t,error:a}=await y.O.from("income").select("\n        *,\n        user:users!user_id (\n          full_name,\n          email\n        ),\n        performed_user:users!performed_by (\n          full_name,\n          email\n        )\n      ").eq("project_id",e).order("created_at",{ascending:!1});if(a)throw a;return t||[]},async updateIncome(e,t){let{data:a,error:s}=await y.O.from("income").update(t).eq("id",e).select("\n        *,\n        user:users!user_id (\n          email\n        )\n      ").single();if(s)throw s;return a},async deleteIncome(e){let{error:t}=await y.O.from("income").delete().eq("id",e);if(t)throw t},async getProjectTotalIncome(e){let{data:t,error:a}=await y.O.from("income").select("amount").eq("project_id",e).eq("status","approved");if(a)throw a;let s=(t||[]).reduce((e,t)=>e+t.amount,0);return s},async uploadIncomeFile(e,t){let a=t.name.split(".").pop(),s="".concat(e,"_").concat(Date.now(),".").concat(a),r="income-files/".concat(s),{error:l}=await y.O.storage.from("documents").upload(r,t);if(l)throw l;let{data:i,error:n}=await y.O.from("income_files").insert({income_id:e,file_name:t.name,file_path:r,file_type:t.type,file_size:t.size}).select().single();if(n)throw n;return i}};var w=a(47),_=a(5270);let C=["Ventas","Servicios","Inversi\xf3n","Consultor\xeda","Comisiones","Intereses","Dividendos","Alquileres","Otros"],k=["Oficina","Marketing","Transporte","Alimentaci\xf3n","Servicios","Equipos","Software","Capacitaci\xf3n","Legal","Impuestos","Otros"],E={async getProjectCategories(e,t){try{let{data:a}=await y.O.auth.getUser(),s=null==a?void 0:a.user;if(!s)return"income"===t?C:k;let r=await this.getUserPreferences(e,s.id,t),{data:l,error:i}=await y.O.from("custom_categories").select("name").eq("project_id",e).eq("type",t).order("name");if(i)throw i;let n=(l||[]).map(e=>e.name),o=n.filter(e=>!r.hidden_categories.includes(e)),c=[...o];if(r.show_default_categories){let e="income"===t?C:k,a=e.filter(e=>!r.hidden_categories.includes(e));c=[...c,...a]}return Array.from(new Set(c)).sort()}catch(e){return console.error("Error fetching project categories:",e),"income"===t?C:k}},async getCustomCategories(e,t){let a=y.O.from("custom_categories").select("*").eq("project_id",e).order("name");t&&(a=a.eq("type",t));let{data:s,error:r}=await a;if(r)throw r;return s||[]},async createCustomCategory(e,t,a){let{data:s}=await y.O.auth.getUser(),r=null==s?void 0:s.user;if(!r)throw Error("Usuario no autenticado");let l=await this.getProjectCategories(e,a),i=l.some(e=>e.toLowerCase()===t.toLowerCase());if(i)throw Error('La categor\xeda "'.concat(t,'" ya existe'));let{data:n,error:o}=await y.O.from("custom_categories").insert({project_id:e,name:t.trim(),type:a,created_by:r.id}).select("*").single();if(o)throw o;return n},async updateCustomCategory(e,t){let{data:a,error:s}=await y.O.from("custom_categories").update({name:t.trim(),updated_at:new Date().toISOString()}).eq("id",e).select("*").single();if(s)throw s;return a},async deleteCustomCategory(e){let{error:t}=await y.O.from("custom_categories").delete().eq("id",e);if(t)throw t},isCustomCategory:(e,t)=>!("income"===t?C:k).includes(e),async getUserPreferences(e,t,a){let{data:s,error:r}=await y.O.from("category_preferences").select("*").eq("project_id",e).eq("user_id",t).eq("type",a).maybeSingle();if(r)throw r;return s||{id:"",project_id:e,user_id:t,type:a,hidden_categories:[],show_default_categories:!0,created_at:"",updated_at:""}},async saveUserPreferences(e,t,a,s){let r,l;let{data:i}=await y.O.auth.getUser(),n=null==i?void 0:i.user;if(!n)throw Error("Usuario no autenticado");let{data:o}=await y.O.from("category_preferences").select("id").eq("project_id",e).eq("user_id",n.id).eq("type",t).maybeSingle();if(o){let e=await y.O.from("category_preferences").update({hidden_categories:a,show_default_categories:s,updated_at:new Date().toISOString()}).eq("id",o.id).select("*").single();r=e.data,l=e.error}else{let i=await y.O.from("category_preferences").insert({project_id:e,user_id:n.id,type:t,hidden_categories:a,show_default_categories:s}).select("*").single();r=i.data,l=i.error}if(l)throw l;return r},async getAllAvailableCategories(e,t){let{data:a,error:s}=await y.O.from("custom_categories").select("name").eq("project_id",e).eq("type",t).order("name");if(s)throw s;let r="income"===t?C:k,l=(a||[]).map(e=>e.name);return{default:r,custom:l}}};var S=a(3673),I=a(9310);function CategoryManagerModal(e){let{projectId:t,type:a,isOpen:r,onClose:i,onCategoriesUpdated:n}=e,[o,c]=(0,l.useState)([]),[d,m]=(0,l.useState)({default:[],custom:[]}),[x,f]=(0,l.useState)(null),[j,b]=(0,l.useState)(""),[N,w]=(0,l.useState)(!1),[_,C]=(0,l.useState)(null),[k,O]=(0,l.useState)(null),[z,D]=(0,l.useState)(!1);(0,l.useEffect)(()=>{r&&loadData()},[r,t,a]);let loadData=async()=>{try{w(!0);let[e,s,r]=await Promise.all([E.getCustomCategories(t,a),E.getAllAvailableCategories(t,a),getCurrentUserPreferences()]);c(e),m(s),f(r)}catch(e){C(e.message||"Error al cargar datos")}finally{w(!1)}},getCurrentUserPreferences=async()=>{try{let{data:e}=await y.O.auth.getUser();if(!(null==e?void 0:e.user))return{id:"",project_id:t,user_id:"",type:a,hidden_categories:[],show_default_categories:!0,created_at:"",updated_at:""};return await E.getUserPreferences(t,e.user.id,a)}catch(e){return console.error("Error getting user preferences:",e),{id:"",project_id:t,user_id:"",type:a,hidden_categories:[],show_default_categories:!0,created_at:"",updated_at:""}}},handleAddCategory=async()=>{if(j.trim())try{C(null),await E.createCustomCategory(t,j,a),b(""),await loadData(),null==n||n()}catch(e){C(e.message||"Error al crear categor\xeda")}},handleDeleteCategory=async e=>{if(confirm("\xbfEliminar esta categor\xeda? Esta acci\xf3n no se puede deshacer."))try{O(e),await E.deleteCustomCategory(e),await loadData(),null==n||n()}catch(e){C(e.message||"Error al eliminar categor\xeda")}finally{O(null)}},handleToggleDefaultCategories=async()=>{if(x)try{let e=!x.show_default_categories;await E.saveUserPreferences(t,a,x.hidden_categories,e),await loadData(),null==n||n()}catch(e){C(e.message||"Error al guardar preferencias")}},handleToggleCategoryVisibility=async e=>{if(x)try{let s=x.hidden_categories.includes(e),r=s?x.hidden_categories.filter(t=>t!==e):[...x.hidden_categories,e];await E.saveUserPreferences(t,a,r,x.show_default_categories),await loadData(),null==n||n()}catch(e){C(e.message||"Error al guardar preferencias")}};if(!r)return null;let U="income"===a?"Ingresos":"Gastos",Z="income"===a?"text-green-600":"text-red-600";return(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between p-6 border-b",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(S.Z,{className:"h-5 w-5 ".concat(Z)}),(0,s.jsxs)("h2",{className:"text-lg font-semibold",children:["Gestionar Categor\xedas de ",U]})]}),(0,s.jsx)(h.z,{variant:"ghost",size:"sm",onClick:i,children:(0,s.jsx)(v.Z,{className:"h-4 w-4"})})]}),(0,s.jsxs)("div",{className:"p-6 space-y-6",children:[_&&(0,s.jsx)("div",{className:"p-3 text-sm text-destructive bg-destructive/10 border border-destructive/20 rounded-md",children:_}),(0,s.jsxs)(p.Zb,{children:[(0,s.jsx)(p.Ol,{children:(0,s.jsx)(p.ll,{className:"text-base",children:"Agregar Nueva Categor\xeda"})}),(0,s.jsx)(p.aY,{className:"space-y-4",children:(0,s.jsxs)("div",{className:"flex gap-4",children:[(0,s.jsx)("div",{className:"flex-1",children:(0,s.jsx)(I.I,{placeholder:"Nombre de la categor\xeda",value:j,onChange:e=>b(e.target.value),onKeyPress:e=>{"Enter"===e.key&&handleAddCategory()}})}),(0,s.jsxs)(h.z,{onClick:handleAddCategory,disabled:!j.trim(),children:[(0,s.jsx)(g.Z,{className:"h-4 w-4 mr-2"}),"Agregar"]})]})})]}),(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("h3",{className:"text-base font-medium",children:"Configuraci\xf3n de Categor\xedas"}),(0,s.jsxs)(h.z,{variant:"ghost",size:"sm",onClick:()=>D(!z),children:[(0,s.jsx)(u.Z,{className:"h-4 w-4 mr-2"}),z?"Ocultar":"Mostrar"," Preferencias"]})]}),z&&x&&(0,s.jsxs)(p.Zb,{children:[(0,s.jsx)(p.Ol,{children:(0,s.jsx)(p.ll,{className:"text-base",children:"Preferencias de Visualizaci\xf3n"})}),(0,s.jsxs)(p.aY,{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-md",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"font-medium",children:"Categor\xedas predeterminadas del sistema"}),(0,s.jsx)("p",{className:"text-sm text-gray-500",children:x.show_default_categories?"Las categor\xedas del sistema est\xe1n visibles en el dropdown":"Las categor\xedas del sistema est\xe1n ocultas del dropdown"})]}),(0,s.jsx)(h.z,{variant:x.show_default_categories?"primary":"outline",size:"sm",onClick:handleToggleDefaultCategories,children:x.show_default_categories?"Ocultar todas":"Mostrar todas"})]}),x.show_default_categories&&(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{className:"font-medium mb-3",children:"Categor\xedas Predeterminadas"}),(0,s.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2",children:d.default.map(e=>{let t=x.hidden_categories.includes(e);return(0,s.jsxs)("div",{className:"flex items-center justify-between p-2 border rounded-md ".concat(t?"bg-gray-100":"bg-white"),children:[(0,s.jsx)("span",{className:"text-sm ".concat(t?"line-through text-gray-500":"text-gray-800"),children:e}),(0,s.jsx)("button",{onClick:()=>handleToggleCategoryVisibility(e),className:"px-2 py-1 text-xs font-medium rounded transition-colors ".concat(t?"bg-gray-200 text-gray-700 hover:bg-gray-300":"bg-blue-100 text-blue-700 hover:bg-blue-200"),title:t?"Mostrar categor\xeda":"Ocultar categor\xeda",children:t?"Mostrar":"Ocultar"})]},e)})})]})]})]}),(0,s.jsxs)(p.Zb,{children:[(0,s.jsx)(p.Ol,{children:(0,s.jsxs)(p.ll,{className:"text-base ".concat(Z),children:["Categor\xedas Personalizadas (",o.length,")"]})}),(0,s.jsxs)(p.aY,{className:"space-y-3",children:[(0,s.jsx)("p",{className:"text-xs text-gray-500",children:"Puedes ocultar categor\xedas personalizadas sin eliminarlas. Las categor\xedas ocultas no aparecer\xe1n en el dropdown."}),N?(0,s.jsx)("div",{className:"text-center py-4 text-sm text-gray-500",children:"Cargando..."}):0===o.length?(0,s.jsx)("div",{className:"text-center py-4 text-sm text-gray-500",children:"No hay categor\xedas personalizadas"}):(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:o.map(e=>{let t=!!x&&x.hidden_categories.includes(e.name);return(0,s.jsxs)("div",{className:"flex items-center justify-between p-2 border rounded-md ".concat(t?"bg-gray-100":"bg-gray-50"),children:[(0,s.jsx)("span",{className:"text-sm ".concat(t?"line-through text-gray-500":"text-gray-800"),children:e.name}),(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[(0,s.jsx)("button",{onClick:()=>handleToggleCategoryVisibility(e.name),className:"px-2 py-1 text-xs font-medium rounded transition-colors ".concat(t?"bg-gray-200 text-gray-700 hover:bg-gray-300":"bg-blue-100 text-blue-700 hover:bg-blue-200"),title:t?"Mostrar categor\xeda":"Ocultar categor\xeda",children:t?"Mostrar":"Ocultar"}),(0,s.jsx)("button",{onClick:()=>handleDeleteCategory(e.id),disabled:k===e.id,className:"px-2 py-1 text-xs font-medium rounded bg-red-100 text-red-700 hover:bg-red-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"Eliminar categor\xeda personalizada",children:k===e.id?"Eliminando...":"Eliminar"})]})]},e.id)})})]})]}),(0,s.jsx)("div",{className:"text-xs text-gray-500 text-center",children:"Las preferencias se guardan autom\xe1ticamente y solo afectan a tu vista del proyecto. Las categor\xedas personalizadas son visibles para todos los miembros del proyecto."})]})]})})}function AddIncomeForm(e){var t,a,r,i;let{projectId:n,onSuccess:c}=e,[d,m]=(0,l.useState)(!1),[x,u]=(0,l.useState)(null),[g,C]=(0,l.useState)([]),[k,S]=(0,l.useState)(!1),[I,O]=(0,l.useState)([]),[z,D]=(0,l.useState)(null),[U,Z]=(0,l.useState)([]),[P,F]=(0,l.useState)(!1);(0,l.useEffect)(()=>{let loadData=async()=>{try{let{data:{user:e}}=await y.O.auth.getUser();e&&D(e.id);let t=await w.C.getProjectMembers(n);O(t);let a=await E.getProjectCategories(n,"income");Z(a)}catch(e){console.error("Error loading data:",e)}};loadData()},[n]);let handleCategoriesUpdated=async()=>{try{let e=await E.getProjectCategories(n,"income");Z(e)}catch(e){console.error("Error reloading categories:",e)}},{register:q,handleSubmit:T,formState:{errors:M},reset:A,setValue:R,watch:V,control:L}=(0,f.cI)({resolver:(0,j.F)(_.fM),defaultValues:{income_date:new Date().toISOString().split("T")[0]}}),B=V("performed_by"),G=V("category"),[Y,W]=(0,l.useState)("");(0,l.useEffect)(()=>{!B&&z&&R("performed_by",z)},[z,B,R,I]);let formatNumber=e=>{let t=e.replace(/\D/g,"");return t.length>3?t.replace(/\B(?=(\d{3})+(?!\d))/g,"."):t},removeFile=e=>{C(t=>t.filter((t,a)=>a!==e))},formatFileSize=e=>{if(0===e)return"0 Bytes";let t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]},onSubmit=async e=>{try{m(!0),u(null);let t=await N.createIncome(n,{description:e.description,amount:Number(e.amount),category:e.category,income_date:e.income_date,performed_by:e.performed_by});if(g.length>0)for(let e of(S(!0),g))await N.uploadIncomeFile(t.id,e);A({income_date:new Date().toISOString().split("T")[0]}),C([]),W(""),z&&R("performed_by",z),null==c||c()}catch(e){u(e instanceof Error?e.message:"Error al crear el ingreso")}finally{m(!1),S(!1)}};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(p.Zb,{children:[(0,s.jsxs)(p.Ol,{children:[(0,s.jsxs)(p.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(o.Z,{className:"h-5 w-5 text-green-600"}),"Agregar Ingreso"]}),(0,s.jsx)(p.SZ,{children:"Registra un nuevo ingreso para el proyecto"})]}),(0,s.jsx)(p.aY,{children:(0,s.jsxs)("form",{onSubmit:T(onSubmit),className:"space-y-6",children:[x&&(0,s.jsx)("div",{className:"p-3 text-sm text-destructive bg-destructive/10 border border-destructive/20 rounded-md",children:x}),(0,s.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{htmlFor:"category",className:"text-sm font-medium text-center block",children:"Categor\xeda *"}),(0,s.jsxs)("select",{id:"category",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm text-center ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",...q("category"),children:[(0,s.jsx)("option",{value:"",children:"Seleccionar categor\xeda"}),U.map(e=>(0,s.jsx)("option",{value:e,children:e},e))]}),M.category&&(0,s.jsx)("p",{className:"text-sm text-destructive text-center",children:M.category.message}),(0,s.jsx)("button",{type:"button",onClick:()=>F(!0),className:"text-xs text-blue-600 hover:text-blue-800 hover:underline",children:"Gestionar categor\xedas"})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{htmlFor:"amount",className:"text-sm font-medium text-center block",children:"Monto *"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("span",{className:"absolute left-3 top-3 text-sm text-muted-foreground",children:"$"}),(0,s.jsx)("input",{id:"amount",type:"text",placeholder:"100.000",className:"flex h-10 w-full rounded-md border border-input bg-background py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",style:{textAlign:"center",paddingLeft:"32px",paddingRight:"32px"},value:Y,onChange:e=>{let t=e.target.value,a=formatNumber(t);W(a);let s=parseInt(a.replace(/\./g,""))||0;R("amount",s,{shouldValidate:!0})}})]}),(0,s.jsx)("p",{className:"text-xs text-muted-foreground text-center",children:"Formato autom\xe1tico (ej: 100.000)"}),M.amount&&(0,s.jsx)("p",{className:"text-sm text-destructive text-center",children:M.amount.message})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{htmlFor:"income_date",className:"text-sm font-medium text-center block",children:"Fecha *"}),(0,s.jsx)("input",{id:"income_date",type:"date",className:"flex h-10 w-full rounded-md border border-input bg-background py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",style:{textAlign:"center",paddingLeft:"40px",paddingRight:"40px"},...q("income_date")}),M.income_date&&(0,s.jsx)("p",{className:"text-sm text-destructive text-center",children:M.income_date.message})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{htmlFor:"performed_by",className:"text-sm font-medium text-center block",children:"Realizado por *"}),(0,s.jsx)(f.Qr,{name:"performed_by",control:L,render:e=>{let{field:t}=e;return(0,s.jsxs)("select",{id:"performed_by",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm text-center ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",value:t.value&&""!==t.value?t.value:z||"",onChange:t.onChange,children:[(0,s.jsx)("option",{value:"",children:"Seleccionar usuario"}),z&&!I.some(e=>e.user_id===z)&&(0,s.jsx)("option",{value:z,children:"T\xfa"}),I.map(e=>{var t,a;return(0,s.jsxs)("option",{value:e.user_id,children:[(null===(t=e.user)||void 0===t?void 0:t.full_name)||(null===(a=e.user)||void 0===a?void 0:a.email)||"Sin nombre",e.user_id===z&&" (T\xfa)"]},e.user_id)})]})}}),M.performed_by&&(0,s.jsx)("p",{className:"text-sm text-destructive",children:M.performed_by.message})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm font-medium text-gray-600 text-center block",children:"Registrado por"}),(0,s.jsx)("div",{className:"flex h-10 w-full rounded-md border border-input bg-gray-50 px-3 py-2 text-sm text-gray-600 items-center justify-center",children:(null===(a=I.find(e=>e.user_id===z))||void 0===a?void 0:null===(t=a.user)||void 0===t?void 0:t.full_name)||(null===(i=I.find(e=>e.user_id===z))||void 0===i?void 0:null===(r=i.user)||void 0===r?void 0:r.email)||"Usuario actual"})]})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsxs)("label",{htmlFor:"description",className:"text-sm font-medium text-center block",children:["Descripci\xf3n ","Otros"===G?"*":"(Opcional)"]}),(0,s.jsx)("textarea",{id:"description",placeholder:"Otros"===G?"Describe detalladamente el tipo de ingreso...":"Describe el ingreso, fuente, detalles adicionales...",className:"flex min-h-[100px] w-full rounded-md border border-input bg-background px-3 py-3 text-sm text-center ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 resize-none",...q("description")}),M.description&&(0,s.jsx)("p",{className:"text-sm text-destructive text-center",children:M.description.message})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm font-medium text-center block",children:"Documentos de respaldo"}),(0,s.jsx)("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)(b.Z,{className:"mx-auto h-8 w-8 text-gray-400"}),(0,s.jsx)("div",{className:"mt-2",children:(0,s.jsxs)("label",{htmlFor:"files",className:"cursor-pointer",children:[(0,s.jsx)("span",{className:"text-sm text-primary hover:underline",children:"Seleccionar archivos"}),(0,s.jsx)("input",{id:"files",type:"file",multiple:!0,accept:"image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx",className:"hidden",onChange:e=>{if(e.target.files){let t=Array.from(e.target.files);C(e=>[...e,...t])}}})]})}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Im\xe1genes, videos, PDF, Word, Excel"})]})}),g.length>0&&(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("p",{className:"text-sm font-medium",children:"Archivos seleccionados:"}),g.map((e,t)=>(0,s.jsxs)("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded",children:[(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("p",{className:"text-sm font-medium",children:e.name}),(0,s.jsx)("p",{className:"text-xs text-gray-500",children:formatFileSize(e.size)})]}),(0,s.jsx)(h.z,{type:"button",variant:"ghost",size:"sm",onClick:()=>removeFile(t),children:(0,s.jsx)(v.Z,{className:"h-4 w-4"})})]},t))]})]})]}),(0,s.jsx)(h.z,{type:"submit",className:"w-full",loading:d||k,children:k?"Subiendo archivos...":"Agregar Ingreso"})]})})]}),(0,s.jsx)(CategoryManagerModal,{projectId:n,type:"income",isOpen:P,onClose:()=>F(!1),onCategoriesUpdated:handleCategoriesUpdated})]})}var O=a(5367),z=a(2894);function ConfirmModal(e){let{isOpen:t,onClose:a,onConfirm:r,title:l,message:i,confirmText:n="Confirmar",cancelText:o="Cancelar",isLoading:c=!1,variant:d="danger"}=e;return t?(0,s.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 animate-in fade-in duration-200",children:(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full animate-in zoom-in-95 duration-200",onClick:e=>e.stopPropagation(),children:[(0,s.jsxs)("div",{className:"flex items-start justify-between p-4 sm:p-6 border-b",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("div",{className:"p-2 rounded-full ".concat("danger"===d?"bg-red-100":"bg-yellow-100"),children:(0,s.jsx)(z.Z,{className:"h-5 w-5 sm:h-6 sm:w-6 ".concat("danger"===d?"text-red-600":"text-yellow-600")})}),(0,s.jsx)("h3",{className:"text-lg sm:text-xl font-semibold text-gray-900",children:l})]}),(0,s.jsx)("button",{onClick:a,className:"text-gray-400 hover:text-gray-600 transition-colors",disabled:c,children:(0,s.jsx)(v.Z,{className:"h-5 w-5"})})]}),(0,s.jsx)("div",{className:"p-4 sm:p-6",children:(0,s.jsx)("p",{className:"text-sm sm:text-base text-gray-600",children:i})}),(0,s.jsxs)("div",{className:"flex flex-col-reverse sm:flex-row gap-3 p-4 sm:p-6 bg-gray-50 rounded-b-lg",children:[(0,s.jsx)(h.z,{variant:"outline",onClick:a,disabled:c,className:"w-full sm:w-auto",children:o}),(0,s.jsx)(h.z,{onClick:()=>{r()},disabled:c,loading:c,className:"w-full sm:w-auto ".concat("danger"===d?"bg-red-600 hover:bg-red-700 text-white":"bg-yellow-600 hover:bg-yellow-700 text-white"),children:n})]})]})}):null}var D=a(4018);let U={COP:{code:"COP",symbol:"$",name:"Peso Colombiano",locale:"es-CO"},AUD:{code:"AUD",symbol:"A$",name:"D\xf3lar Australiano",locale:"en-AU"}};function formatCurrency(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"COP",a=U[t];return"COP"===t?"$".concat(new Intl.NumberFormat("es-CO").format(e)," COP"):new Intl.NumberFormat(a.locale,{style:"currency",currency:a.code,minimumFractionDigits:0,maximumFractionDigits:2}).format(e)}let Z={owner:{role:"owner",permissions:["read","write","delete","admin","manage_members"],description:"Propietario del proyecto con acceso completo"},admin:{role:"admin",permissions:["read","write","delete","manage_members"],description:"Administrador con permisos completos excepto configuraci\xf3n del proyecto"},normal:{role:"normal",permissions:["read","write"],description:"Usuario normal que puede ver y crear ingresos/egresos pero no eliminar"},view:{role:"view",permissions:["read"],description:"Usuario de solo lectura que \xfanicamente puede ver el resumen"}},P={hasPermission(e,t){var a;return(null===(a=Z[e])||void 0===a?void 0:a.permissions.includes(t))||!1},getRolePermissions(e){var t;return(null===(t=Z[e])||void 0===t?void 0:t.permissions)||[]},getRoleDescription(e){var t;return(null===(t=Z[e])||void 0===t?void 0:t.description)||""},canView(e){return this.hasPermission(e,"read")},canEdit(e){return this.hasPermission(e,"write")},canDelete(e){return this.hasPermission(e,"delete")},canManageProject(e){return this.hasPermission(e,"admin")},canManageMembers(e){return this.hasPermission(e,"manage_members")},getAssignableRoles:()=>["admin","normal","view"],getRoleDisplayName:e=>({owner:"Propietario",admin:"Administrador",normal:"Usuario Normal",view:"Solo Vista"})[e]||e,getRoleColor:e=>({owner:"bg-purple-100 text-purple-800",admin:"bg-blue-100 text-blue-800",normal:"bg-green-100 text-green-800",view:"bg-gray-100 text-gray-800"})[e]||"bg-gray-100 text-gray-800"};function useConfirm(){let[e,t]=(0,l.useState)(!1),[a,s]=(0,l.useState)(!1),[r,i]=(0,l.useState)({title:"",message:"",confirmText:"Confirmar",cancelText:"Cancelar",variant:"danger"}),[n,o]=(0,l.useState)(null),c=(0,l.useCallback)(e=>new Promise(a=>{i({...e,confirmText:e.confirmText||"Confirmar",cancelText:e.cancelText||"Cancelar",variant:e.variant||"danger"}),t(!0),o(()=>a)}),[]),d=(0,l.useCallback)(()=>{n&&n(!0),t(!1),s(!1),o(null)},[n]),m=(0,l.useCallback)(()=>{n&&n(!1),t(!1),s(!1),o(null)},[n]);return{confirm:c,isOpen:e,isLoading:a,setIsLoading:s,options:r,handleConfirm:d,handleCancel:m}}function IncomeList(e){let{income:t,currentUserId:a,userRole:r="view",onUpdate:i}=e,[n,c]=(0,l.useState)(null),d=useConfirm(),{error:m}=(0,D.useToast)(),handleDelete=async e=>{let t=await d.confirm({title:"Eliminar Ingreso",message:"\xbfEst\xe1s seguro de que quieres eliminar este ingreso? Esta acci\xf3n no se puede deshacer.",confirmText:"Eliminar",cancelText:"Cancelar",variant:"danger"});if(t)try{c(e),await N.deleteIncome(e),null==i||i()}catch(e){console.error("Error deleting income:",e),m("Error al eliminar el ingreso")}finally{c(null)}};return 0===t.length?(0,s.jsx)(p.Zb,{children:(0,s.jsxs)(p.aY,{className:"flex flex-col items-center justify-center py-12",children:[(0,s.jsx)(o.Z,{className:"h-12 w-12 text-muted-foreground mb-4"}),(0,s.jsx)("h3",{className:"text-lg font-semibold text-muted-foreground mb-2",children:"No hay ingresos registrados"}),(0,s.jsx)("p",{className:"text-sm text-muted-foreground text-center",children:"Agrega el primer ingreso para comenzar a llevar el control financiero del proyecto."})]})}):(0,s.jsxs)("div",{className:"space-y-4",children:[t.map(e=>{var t,l,i,o;return(0,s.jsxs)(p.Zb,{className:"hover:shadow-md transition-shadow",children:[(0,s.jsx)(p.Ol,{className:"pb-3",children:(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3",children:[(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)(p.ll,{className:"text-lg text-green-700 mb-1",children:formatCurrency(e.amount)}),(0,s.jsx)("h4",{className:"font-semibold text-gray-900 break-words",children:e.category||"Sin categor\xeda"}),e.description&&(0,s.jsx)("p",{className:"text-sm text-gray-600 mt-1 break-words",children:e.description})]}),(0,s.jsx)("div",{className:"flex items-center gap-2 flex-shrink-0",children:(P.canDelete(r)||e.user_id===a&&P.canEdit(r))&&(0,s.jsx)(h.z,{variant:"ghost",size:"sm",onClick:()=>handleDelete(e.id),disabled:n===e.id,className:"text-red-600 hover:text-red-800 hover:bg-red-50",children:(0,s.jsx)(O.Z,{className:"h-4 w-4"})})})]})}),(0,s.jsxs)(p.aY,{className:"pt-0",children:[(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-4 text-sm text-gray-500",children:[(0,s.jsxs)("span",{children:["Fecha: ",new Date(e.income_date).toLocaleDateString("es-CO")]}),e.category&&(0,s.jsx)("span",{className:"bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs",children:e.category}),(0,s.jsx)("span",{className:"bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs",children:"approved"===e.status?"Aprobado":"pending"===e.status?"Pendiente":"Rechazado"})]}),(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-4 text-sm text-gray-500 mt-2",children:[(0,s.jsxs)("span",{children:[(0,s.jsx)("strong",{children:"Realizado por:"})," ",(null===(t=e.performed_user)||void 0===t?void 0:t.full_name)||(null===(l=e.performed_user)||void 0===l?void 0:l.email)||"Usuario desconocido"]}),(0,s.jsxs)("span",{children:[(0,s.jsx)("strong",{children:"Registrado por:"})," ",(null===(i=e.user)||void 0===i?void 0:i.full_name)||(null===(o=e.user)||void 0===o?void 0:o.email)||"Usuario desconocido"]})]}),(0,s.jsxs)("div",{className:"text-xs text-gray-400 mt-2",children:["Registrado: ",new Date(e.created_at).toLocaleDateString("es-CO")," a las"," ",new Date(e.created_at).toLocaleTimeString("es-CO",{hour:"2-digit",minute:"2-digit"})]})]})]},e.id)}),(0,s.jsx)(ConfirmModal,{isOpen:d.isOpen,onClose:d.handleCancel,onConfirm:d.handleConfirm,title:d.options.title,message:d.options.message,confirmText:d.options.confirmText,cancelText:d.options.cancelText,variant:d.options.variant})]})}let F={async createExpense(e,t){let{data:{user:a}}=await y.O.auth.getUser();if(!a)throw Error("Usuario no autenticado");let{data:s,error:r}=await y.O.from("expenses").insert({project_id:e,amount:t.amount,description:t.description,category:t.category,expense_date:t.expense_date,created_by:a.id,performed_by:t.performed_by||a.id}).select("\n        *,\n        user:users!created_by (\n          full_name,\n          email\n        ),\n        performed_user:users!performed_by (\n          full_name,\n          email\n        )\n      ").single();if(r)throw r;return s},async getProjectExpenses(e){let{data:t,error:a}=await y.O.from("expenses").select("\n        *,\n        user:users!created_by (\n          full_name,\n          email\n        ),\n        performed_user:users!performed_by (\n          full_name,\n          email\n        ),\n        expense_files (*)\n      ").eq("project_id",e).order("created_at",{ascending:!1});if(a)throw a;return t},async updateExpense(e,t,a,s){let{data:r,error:l}=await y.O.from("expenses").update({amount:t,description:a,category:s}).eq("id",e).select("\n        *,\n        user:users!created_by (\n          full_name,\n          email\n        ),\n        performed_user:users!performed_by (\n          full_name,\n          email\n        ),\n        expense_files (*)\n      ").single();if(l)throw l;return r},async deleteExpense(e){let{error:t}=await y.O.from("expenses").delete().eq("id",e);if(t)throw t},async uploadExpenseFile(e,t){let a=t.name.split(".").pop(),s="".concat(e,"/").concat(Date.now(),".").concat(a),{data:r,error:l}=await y.O.storage.from("expense-files").upload(s,t,{cacheControl:"3600",upsert:!1});if(l)throw console.error("Storage upload error:",l),Error("Error al subir archivo: ".concat(l.message));let{data:i,error:n}=await y.O.from("expense_files").insert({expense_id:e,file_name:t.name,file_path:r.path,file_type:t.type,file_size:t.size}).select().single();if(n)throw n;return i},async getFileUrl(e){let{data:t}=y.O.storage.from("expense-files").getPublicUrl(e);return t.publicUrl},async uploadFiles(e,t){let a=Array.from(t).map(t=>this.uploadExpenseFile(e,t)),s=await Promise.all(a);return s},async deleteExpenseFile(e,t){let{error:a}=await y.O.storage.from("expense-files").remove([t]);if(a)throw a;let{error:s}=await y.O.from("expense_files").delete().eq("id",e);if(s)throw s},async getProjectTotalExpenses(e){let{data:t,error:a}=await y.O.from("expenses").select("amount").eq("project_id",e);if(a)throw a;let s=t.reduce((e,t)=>e+t.amount,0);return s},async getExpensesByCategory(e){let{data:t,error:a}=await y.O.from("expenses").select("category, amount").eq("project_id",e);if(a)throw a;let s={};return t.forEach(e=>{let t=e.category||"Sin categor\xeda";s[t]=(s[t]||0)+e.amount}),s}};function AddExpenseForm(e){var t,a,r,i;let{projectId:n,onSuccess:o}=e,[d,m]=(0,l.useState)(!1),[x,u]=(0,l.useState)(null),[g,N]=(0,l.useState)([]),[C,k]=(0,l.useState)(!1),[S,I]=(0,l.useState)([]),[O,z]=(0,l.useState)(null),[D,U]=(0,l.useState)([]),[Z,P]=(0,l.useState)(!1);(0,l.useEffect)(()=>{let loadData=async()=>{try{let{data:{user:e}}=await y.O.auth.getUser();e&&z(e.id);let t=await w.C.getProjectMembers(n);I(t);let a=await E.getProjectCategories(n,"expense");U(a)}catch(e){console.error("Error loading data:",e)}};loadData()},[n]);let handleCategoriesUpdated=async()=>{try{let e=await E.getProjectCategories(n,"expense");U(e)}catch(e){console.error("Error reloading categories:",e)}},{register:q,handleSubmit:T,formState:{errors:M},reset:A,setValue:R,control:V,getValues:L,watch:B}=(0,f.cI)({resolver:(0,j.F)(_.zV),defaultValues:{expense_date:new Date().toISOString().split("T")[0]}}),G=B("category"),[Y,W]=(0,l.useState)("");(0,l.useEffect)(()=>{let e=L("performed_by");O&&(!e||""===e)&&R("performed_by",O,{shouldValidate:!0}),R("expense_date",new Date().toISOString().split("T")[0])},[O,L,R]);let formatNumber=e=>{let t=e.replace(/\D/g,"");return t.length>3?t.replace(/\B(?=(\d{3})+(?!\d))/g,"."):t},removeFile=e=>{N(t=>t.filter((t,a)=>a!==e))},onSubmit=async e=>{m(!0),u(null);try{let t=await F.createExpense(n,{amount:Number(e.amount),description:e.description||"",category:e.category,expense_date:e.expense_date,performed_by:e.performed_by});if(g.length>0)for(let e of(k(!0),g))await F.uploadExpenseFile(t.id,e);A({expense_date:new Date().toISOString().split("T")[0]}),N([]),W(""),O&&R("performed_by",O,{shouldValidate:!0}),null==o||o()}catch(e){u(e.message||"Error al agregar el gasto")}finally{m(!1),k(!1)}},formatFileSize=e=>{if(0===e)return"0 Bytes";let t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(p.Zb,{children:[(0,s.jsxs)(p.Ol,{children:[(0,s.jsxs)(p.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(c.Z,{className:"h-5 w-5"}),"Agregar Gasto"]}),(0,s.jsx)(p.SZ,{children:"Registra un nuevo gasto con documentos de respaldo"})]}),(0,s.jsx)(p.aY,{children:(0,s.jsxs)("form",{onSubmit:T(onSubmit),className:"space-y-6",children:[x&&(0,s.jsx)("div",{className:"p-3 text-sm text-destructive bg-destructive/10 border border-destructive/20 rounded-md",children:x}),(0,s.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{htmlFor:"category",className:"text-sm font-medium text-center block",children:"Categor\xeda *"}),(0,s.jsxs)("select",{id:"category",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm text-center ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",...q("category"),children:[(0,s.jsx)("option",{value:"",children:"Seleccionar categor\xeda"}),D.map(e=>(0,s.jsx)("option",{value:e,children:e},e))]}),M.category&&(0,s.jsx)("p",{className:"text-sm text-destructive text-center",children:M.category.message}),(0,s.jsx)("button",{type:"button",onClick:()=>P(!0),className:"text-xs text-blue-600 hover:text-blue-800 hover:underline",children:"Gestionar categor\xedas"})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{htmlFor:"amount",className:"text-sm font-medium text-center block",children:"Monto *"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("span",{className:"absolute left-3 top-3 text-sm text-muted-foreground",children:"$"}),(0,s.jsx)("input",{id:"amount",type:"text",placeholder:"100.000",className:"flex h-10 w-full rounded-md border border-input bg-background py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",style:{textAlign:"center",paddingLeft:"32px",paddingRight:"32px"},value:Y,onChange:e=>{let t=e.target.value,a=formatNumber(t);W(a);let s=parseInt(a.replace(/\./g,""))||0;R("amount",s,{shouldValidate:!0})}})]}),(0,s.jsx)("p",{className:"text-xs text-muted-foreground text-center",children:"Formato autom\xe1tico (ej: 100.000)"}),M.amount&&(0,s.jsx)("p",{className:"text-sm text-destructive text-center",children:M.amount.message})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{htmlFor:"expense_date",className:"text-sm font-medium text-center block",children:"Fecha *"}),(0,s.jsx)("input",{id:"expense_date",type:"date",className:"flex h-10 w-full rounded-md border border-input bg-background py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",style:{textAlign:"center",paddingLeft:"40px",paddingRight:"40px"},...q("expense_date")}),M.expense_date&&(0,s.jsx)("p",{className:"text-sm text-destructive text-center",children:M.expense_date.message})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{htmlFor:"performed_by",className:"text-sm font-medium text-center block",children:"Realizado por *"}),(0,s.jsx)(f.Qr,{name:"performed_by",control:V,render:e=>{let{field:t}=e;return(0,s.jsxs)("select",{id:"performed_by",className:"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm text-center ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",value:t.value&&""!==t.value?t.value:O||"",onChange:t.onChange,children:[(0,s.jsx)("option",{value:"",children:"Seleccionar usuario"}),O&&!S.some(e=>e.user_id===O)&&(0,s.jsx)("option",{value:O,children:"T\xfa"}),S.map(e=>{var t,a;return(0,s.jsxs)("option",{value:e.user_id,children:[(null===(t=e.user)||void 0===t?void 0:t.full_name)||(null===(a=e.user)||void 0===a?void 0:a.email)||"Sin nombre",e.user_id===O&&" (T\xfa)"]},e.user_id)})]})}}),M.performed_by&&(0,s.jsx)("p",{className:"text-sm text-destructive text-center",children:M.performed_by.message})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm font-medium text-gray-600 text-center block",children:"Registrado por"}),(0,s.jsx)("div",{className:"flex h-10 w-full rounded-md border border-input bg-gray-50 px-3 py-2 text-sm text-gray-600 items-center justify-center",children:(null===(a=S.find(e=>e.user_id===O))||void 0===a?void 0:null===(t=a.user)||void 0===t?void 0:t.full_name)||(null===(i=S.find(e=>e.user_id===O))||void 0===i?void 0:null===(r=i.user)||void 0===r?void 0:r.email)||"Usuario actual"})]})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{htmlFor:"description",className:"text-sm font-medium text-center block",children:"Descripci\xf3n *"}),(0,s.jsx)("textarea",{id:"description",placeholder:"Otros"===G?"Describe detalladamente el tipo de gasto...":"Describe el gasto realizado, proveedor, detalles del producto o servicio...",className:"flex min-h-[100px] w-full rounded-md border border-input bg-background px-3 py-3 text-sm text-center ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 resize-none",...q("description")}),M.description&&(0,s.jsx)("p",{className:"text-sm text-destructive text-center",children:M.description.message})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{className:"text-sm font-medium text-center block",children:"Documentos de respaldo"}),(0,s.jsx)("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)(b.Z,{className:"mx-auto h-8 w-8 text-gray-400"}),(0,s.jsx)("div",{className:"mt-2",children:(0,s.jsxs)("label",{htmlFor:"files",className:"cursor-pointer",children:[(0,s.jsx)("span",{className:"text-sm text-primary hover:underline",children:"Seleccionar archivos"}),(0,s.jsx)("input",{id:"files",type:"file",multiple:!0,accept:"image/*,video/*,.pdf,.doc,.docx,.xls,.xlsx",className:"hidden",onChange:e=>{if(e.target.files){let t=Array.from(e.target.files);N(e=>[...e,...t])}}})]})}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Im\xe1genes, videos, PDF, Word, Excel"})]})}),g.length>0&&(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("p",{className:"text-sm font-medium",children:"Archivos seleccionados:"}),g.map((e,t)=>(0,s.jsxs)("div",{className:"flex items-center justify-between p-2 bg-gray-50 rounded",children:[(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("p",{className:"text-sm font-medium",children:e.name}),(0,s.jsx)("p",{className:"text-xs text-gray-500",children:formatFileSize(e.size)})]}),(0,s.jsx)(h.z,{type:"button",variant:"ghost",size:"sm",onClick:()=>removeFile(t),children:(0,s.jsx)(v.Z,{className:"h-4 w-4"})})]},t))]})]})]}),(0,s.jsx)(h.z,{type:"submit",className:"w-full",loading:d||C,children:C?"Subiendo archivos...":"Agregar Gasto"})]})})]}),(0,s.jsx)(CategoryManagerModal,{projectId:n,type:"expense",isOpen:Z,onClose:()=>P(!1),onCategoriesUpdated:handleCategoriesUpdated})]})}var q=a(8203),T=a(1942),M=a(9670),A=a(5817),R=a(6194),V=a(1094),L=a(3086);function FilePreviewModal(e){let{isOpen:t,onClose:a,file:r}=e,[i,n]=(0,l.useState)(null),[o,c]=(0,l.useState)(!1),[d,m]=(0,l.useState)(null),[x,u]=(0,l.useState)(100),[g,p]=(0,l.useState)(0);(0,l.useEffect)(()=>{t&&r?loadFileUrl():(n(null),m(null),u(100),p(0))},[t,r]);let loadFileUrl=async()=>{if(r){c(!0),m(null);try{let e=await F.getFileUrl(r.file_path);n(e)}catch(e){m("Error al cargar el archivo"),console.error("Error loading file:",e)}finally{c(!1)}}},handleDownload=async()=>{if(r&&i)try{let e=document.createElement("a");e.href=i,e.download=r.file_name,document.body.appendChild(e),e.click(),document.body.removeChild(e)}catch(e){console.error("Error downloading file:",e)}},f=null==r?void 0:r.file_type.startsWith("image/"),j=null==r?void 0:r.file_type.includes("pdf"),b=null==r?void 0:r.file_type.startsWith("video/");return t&&r?(0,s.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75",children:(0,s.jsxs)("div",{className:"relative w-full h-full max-w-6xl max-h-screen bg-white rounded-lg shadow-xl overflow-hidden",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between p-4 border-b bg-gray-50",children:[(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold truncate",children:r.file_name}),(0,s.jsxs)("p",{className:"text-sm text-gray-500",children:[r.file_type," • ",formatFileSize(r.file_size)]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[f&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(h.z,{variant:"ghost",size:"sm",onClick:()=>u(Math.max(25,x-25)),disabled:x<=25,children:(0,s.jsx)(R.Z,{className:"h-4 w-4"})}),(0,s.jsxs)("span",{className:"text-sm text-gray-600 min-w-[60px] text-center",children:[x,"%"]}),(0,s.jsx)(h.z,{variant:"ghost",size:"sm",onClick:()=>u(Math.min(300,x+25)),disabled:x>=300,children:(0,s.jsx)(V.Z,{className:"h-4 w-4"})}),(0,s.jsx)(h.z,{variant:"ghost",size:"sm",onClick:()=>p((g+90)%360),children:(0,s.jsx)(L.Z,{className:"h-4 w-4"})})]}),(0,s.jsx)(h.z,{variant:"ghost",size:"sm",onClick:handleDownload,children:(0,s.jsx)(A.Z,{className:"h-4 w-4"})}),(0,s.jsx)(h.z,{variant:"ghost",size:"sm",onClick:a,children:(0,s.jsx)(v.Z,{className:"h-4 w-4"})})]})]}),(0,s.jsxs)("div",{className:"flex-1 overflow-auto p-4 bg-gray-100 h-[calc(100vh-80px)]",children:[o&&(0,s.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),(0,s.jsx)("p",{className:"text-gray-600",children:"Cargando archivo..."})]})}),d&&(0,s.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("p",{className:"text-red-600 mb-4",children:d}),(0,s.jsx)(h.z,{onClick:loadFileUrl,children:"Reintentar"})]})}),i&&!o&&!d&&(0,s.jsxs)("div",{className:"flex items-center justify-center h-full",children:[f&&(0,s.jsx)("img",{src:i,alt:r.file_name,className:"max-w-full max-h-full object-contain",style:{transform:"scale(".concat(x/100,") rotate(").concat(g,"deg)"),transition:"transform 0.2s ease-in-out"}}),j&&(0,s.jsx)("iframe",{src:i,className:"w-full h-full border-0",title:r.file_name}),b&&(0,s.jsx)("video",{src:i,controls:!0,className:"max-w-full max-h-full",style:{maxHeight:"80vh"},children:"Tu navegador no soporta la reproducci\xf3n de video."}),!f&&!j&&!b&&(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"text-6xl mb-4",children:"\uD83D\uDCC4"}),(0,s.jsx)("p",{className:"text-gray-600 mb-4",children:"Vista previa no disponible para este tipo de archivo"}),(0,s.jsxs)(h.z,{onClick:handleDownload,children:[(0,s.jsx)(A.Z,{className:"h-4 w-4 mr-2"}),"Descargar archivo"]})]})]})]})]})}):null}function formatFileSize(e){if(0===e)return"0 Bytes";let t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]}function ExpensesList(e){let{expenses:t,currentUserId:a,userRole:r="view",onUpdate:i}=e,[n,o]=(0,l.useState)(null),[d,m]=(0,l.useState)(null),[x,u]=(0,l.useState)(null),{toasts:g,removeToast:f,success:j,error:v}=(0,D.useToast)(),y=useConfirm(),[N,w]=(0,l.useState)(null),handleDelete=async e=>{let t=await y.confirm({title:"Eliminar Gasto",message:"\xbfEst\xe1s seguro de que quieres eliminar este gasto? Esta acci\xf3n no se puede deshacer.",confirmText:"Eliminar",cancelText:"Cancelar",variant:"danger"});if(t){o(e);try{await F.deleteExpense(e),null==i||i()}catch(e){console.error("Error deleting expense:",e),v("Error al eliminar el gasto")}finally{o(null)}}},handleFileDownload=async(e,t)=>{try{let a=await F.getFileUrl(e),s=document.createElement("a");s.href=a,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s)}catch(e){console.error("Error downloading file:",e),v("Error al descargar el archivo")}},handleFileUpload=async(e,t)=>{if(t&&0!==t.length){u(e);try{await F.uploadFiles(e,t),null==i||i(),j("✅ ".concat(t.length," archivo").concat(t.length>1?"s":""," subido").concat(t.length>1?"s":""," exitosamente"))}catch(e){console.error("Error uploading files:",e),v("❌ Error al subir los archivos. Int\xe9ntalo nuevamente.")}finally{u(null)}}},triggerFileUpload=e=>{let t=document.createElement("input");t.type="file",t.multiple=!0,t.accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.gif,.mp4,.mov",t.onchange=t=>{let a=t.target.files;a&&handleFileUpload(e,a)},t.click()},formatCurrency=e=>"$".concat(new Intl.NumberFormat("es-CO").format(e)," COP"),formatDate=e=>new Date(e).toLocaleDateString("es-ES",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}),formatFileSize=e=>{if(0===e)return"0 Bytes";let t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t]},getFileIcon=e=>e.startsWith("image/")?"\uD83D\uDDBC️":e.startsWith("video/")?"\uD83C\uDFA5":e.includes("pdf")?"\uD83D\uDCC4":e.includes("word")||e.includes("document")?"\uD83D\uDCDD":e.includes("sheet")||e.includes("excel")?"\uD83D\uDCCA":"\uD83D\uDCCE";if(0===t.length)return(0,s.jsx)(p.Zb,{children:(0,s.jsx)(p.aY,{className:"pt-6",children:(0,s.jsxs)("div",{className:"text-center py-8",children:[(0,s.jsx)(c.Z,{className:"mx-auto h-12 w-12 text-gray-400"}),(0,s.jsx)("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No hay gastos registrados"}),(0,s.jsx)("p",{className:"mt-1 text-sm text-gray-500",children:"Comienza agregando el primer gasto del proyecto."})]})})});let _=t.reduce((e,t)=>e+t.amount,0);return(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)(p.Zb,{children:[(0,s.jsx)(p.Ol,{children:(0,s.jsxs)(p.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(c.Z,{className:"h-5 w-5"}),"Total de Gastos"]})}),(0,s.jsxs)(p.aY,{children:[(0,s.jsx)("div",{className:"text-3xl font-bold text-red-600",children:formatCurrency(_)}),(0,s.jsx)("p",{className:"text-sm text-muted-foreground mt-1",children:"Suma de todos los gastos registrados"})]})]}),(0,s.jsxs)(p.Zb,{children:[(0,s.jsxs)(p.Ol,{children:[(0,s.jsx)(p.ll,{children:"Historial de Gastos"}),(0,s.jsx)(p.SZ,{children:"Todos los gastos registrados en el proyecto"})]}),(0,s.jsx)(p.aY,{children:(0,s.jsx)("div",{className:"space-y-4",children:t.map(e=>{var t,l,i,o;return(0,s.jsxs)("div",{className:"border rounded-lg p-4 hover:bg-gray-50",children:[(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3",children:[(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)(p.ll,{className:"text-lg text-red-700 mb-1",children:formatCurrency(e.amount)}),(0,s.jsx)("h4",{className:"font-semibold text-gray-900 break-words",children:e.category}),(0,s.jsx)("p",{className:"text-sm text-gray-600 mt-1 break-words",children:e.description})]}),(0,s.jsx)("div",{className:"flex items-center gap-2 flex-shrink-0",children:(P.canDelete(r)||e.created_by===a&&P.canEdit(r))&&(0,s.jsx)(h.z,{variant:"ghost",size:"sm",onClick:()=>handleDelete(e.id),disabled:n===e.id,className:"text-red-600 hover:text-red-800 hover:bg-red-50",children:(0,s.jsx)(O.Z,{className:"h-4 w-4"})})})]}),(0,s.jsxs)("div",{className:"mt-3 space-y-2",children:[(0,s.jsxs)("div",{className:"flex items-center gap-4 text-xs text-gray-500",children:[(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[(0,s.jsx)(q.Z,{className:"h-3 w-3"}),(0,s.jsx)("span",{children:formatDate(e.created_at)})]}),e.category&&(0,s.jsxs)("div",{className:"flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs",children:[(0,s.jsx)(S.Z,{className:"h-3 w-3"}),e.category]}),e.expense_files&&e.expense_files.length>0&&(0,s.jsxs)("div",{className:"flex items-center gap-1 text-gray-500",children:[(0,s.jsx)(T.Z,{className:"h-4 w-4"}),(0,s.jsx)("span",{className:"text-xs",children:e.expense_files.length})]})]}),(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-4 text-xs text-gray-500",children:[(0,s.jsxs)("span",{children:[(0,s.jsx)("strong",{children:"Realizado por:"})," ",(null===(t=e.performed_user)||void 0===t?void 0:t.full_name)||(null===(l=e.performed_user)||void 0===l?void 0:l.email)||(e.performed_by===a?"T\xfa":"Usuario desconocido")]}),(0,s.jsxs)("span",{children:[(0,s.jsx)("strong",{children:"Registrado por:"})," ",(null===(i=e.user)||void 0===i?void 0:i.full_name)||(null===(o=e.user)||void 0===o?void 0:o.email)||"Usuario desconocido"]})]}),(0,s.jsxs)("div",{className:"mt-3",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[e.expense_files&&e.expense_files.length>0&&(0,s.jsxs)(h.z,{variant:"ghost",size:"sm",onClick:()=>m(d===e.id?null:e.id),children:[(0,s.jsx)(M.Z,{className:"h-4 w-4 mr-1"}),d===e.id?"Ocultar":"Ver"," archivos (",e.expense_files.length,")"]}),P.canEdit(r)&&(0,s.jsxs)(h.z,{variant:"ghost",size:"sm",onClick:()=>triggerFileUpload(e.id),disabled:x===e.id,className:"text-blue-600 hover:text-blue-800 hover:bg-blue-50",children:[(0,s.jsx)(b.Z,{className:"h-4 w-4 mr-1"}),x===e.id?"Subiendo...":"Subir archivos"]})]}),e.expense_files&&e.expense_files.length>0&&d===e.id&&(0,s.jsx)("div",{className:"mt-2 space-y-2",children:e.expense_files.map(e=>(0,s.jsxs)("div",{className:"flex items-center justify-between p-2 bg-gray-100 rounded text-sm hover:bg-gray-200 transition-colors",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 flex-1 cursor-pointer",onClick:()=>w({id:e.id,file_name:e.file_name,file_path:e.file_path,file_type:e.file_type,file_size:e.file_size}),children:[(0,s.jsx)("span",{children:getFileIcon(e.file_type)}),(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"font-medium text-blue-600 hover:text-blue-800",children:e.file_name}),(0,s.jsxs)("p",{className:"text-xs text-gray-500",children:[formatFileSize(e.file_size)," • ",formatDate(e.uploaded_at)]})]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[(0,s.jsx)(h.z,{variant:"ghost",size:"sm",onClick:()=>w({id:e.id,file_name:e.file_name,file_path:e.file_path,file_type:e.file_type,file_size:e.file_size}),title:"Vista previa",children:(0,s.jsx)(M.Z,{className:"h-4 w-4"})}),(0,s.jsx)(h.z,{variant:"ghost",size:"sm",onClick:()=>handleFileDownload(e.file_path,e.file_name),title:"Descargar",children:(0,s.jsx)(A.Z,{className:"h-4 w-4"})})]})]},e.id))})]})]}),(P.canDelete(r)||e.created_by===a&&P.canEdit(r))&&(0,s.jsx)("div",{className:"flex items-center gap-2",children:(0,s.jsx)(h.z,{variant:"ghost",size:"sm",onClick:()=>handleDelete(e.id),disabled:n===e.id,className:"text-red-600 hover:text-red-800 hover:bg-red-50",children:(0,s.jsx)(O.Z,{className:"h-4 w-4"})})})]},e.id)})})})]}),(0,s.jsx)(FilePreviewModal,{isOpen:!!N,onClose:()=>w(null),file:N}),(0,s.jsx)(ConfirmModal,{isOpen:y.isOpen,onClose:y.handleCancel,onConfirm:y.handleConfirm,title:y.options.title,message:y.options.message,confirmText:y.options.confirmText,cancelText:y.options.cancelText,variant:y.options.variant})]})}let B="inventory-files",G={async createItem(e,t){var a,s;let{data:r}=await y.O.auth.getUser(),l=null==r?void 0:r.user;if(!l)throw Error("Usuario no autenticado");let{data:i,error:n}=await y.O.from("inventory_items").insert({project_id:e,name:t.name,description:null!==(a=t.description)&&void 0!==a?a:null,unit_value:null!==(s=t.unit_value)&&void 0!==s?s:null,created_by:l.id}).select("*").single();if(n)throw n;return i},async getProjectItems(e){let{data:t,error:a}=await y.O.from("inventory_items").select("\n        *,\n        files:inventory_files (*)\n      ").eq("project_id",e).order("created_at",{ascending:!1});if(a)throw a;let s=(t||[]).map(e=>({...e,unit_value:null===e.unit_value||void 0===e.unit_value?null:Number(e.unit_value)}));return s},async getItemStateQuantities(e){let{data:t,error:a}=await y.O.from("inventory_item_state_quantities").select("*").eq("project_id",e);if(a)throw a;return t||[]},async getItemsWithQuantities(e){let[t,a]=await Promise.all([this.getProjectItems(e),this.getItemStateQuantities(e)]),s=new Map(a.map(e=>[e.item_id,e]));return t.map(e=>{var t,a,r;let l=s.get(e.id);return{...e,qty_bodega:null!==(t=null==l?void 0:l.qty_bodega)&&void 0!==t?t:0,qty_uso:null!==(a=null==l?void 0:l.qty_uso)&&void 0!==a?a:0,qty_gastado:null!==(r=null==l?void 0:l.qty_gastado)&&void 0!==r?r:0}})},async updateItem(e,t){let{data:a,error:s}=await y.O.from("inventory_items").update(t).eq("id",e).select("*").single();if(s)throw s;return a},async createMovement(e,t,a){var s;if(a.quantity<=0)throw Error("La cantidad debe ser mayor que cero");let{data:r}=await y.O.auth.getUser(),l=null==r?void 0:r.user;if(!l)throw Error("Usuario no autenticado");let{data:i,error:n}=await y.O.from("inventory_movements").insert({item_id:e,project_id:t,quantity:Math.floor(a.quantity),from_state:a.from_state,to_state:a.to_state,note:null!==(s=a.note)&&void 0!==s?s:null,created_by:l.id}).select("*").single();if(n)throw n;return i},async getProjectMovements(e){let{data:t,error:a}=await y.O.from("inventory_movements").select("*").eq("project_id",e).order("created_at",{ascending:!1});if(a)throw a;return t||[]},async uploadItemFile(e,t){let a=t.name.split(".").pop(),s="".concat(e,"/").concat(Date.now(),".").concat(a),{data:r,error:l}=await y.O.storage.from(B).upload(s,t,{cacheControl:"3600",upsert:!1});if(l)throw Error("Error al subir archivo: ".concat(l.message));let{data:i,error:n}=await y.O.from("inventory_files").insert({item_id:e,file_name:t.name,file_path:r.path,file_type:t.type,file_size:t.size}).select("*").single();if(n)throw n;return i},async uploadItemFiles(e,t){let a=t instanceof FileList?Array.from(t):t,s=a.map(t=>this.uploadItemFile(e,t));return Promise.all(s)},getFileUrl(e){let{data:t}=y.O.storage.from(B).getPublicUrl(e);return t.publicUrl},async replaceItemImage(e,t){try{let{data:t}=await y.O.from("inventory_files").select("id,file_path").eq("item_id",e),a=(t||[]).map(e=>e.file_path);a.length>0&&(await y.O.storage.from(B).remove(a),await y.O.from("inventory_files").delete().eq("item_id",e))}catch(t){console.warn("Error cleaning previous images for item",e,t)}let a=await this.uploadItemFile(e,t),s=this.getFileUrl(a.file_path);return await this.updateItem(e,{thumbnail_url:s}),{file:a,thumbnail_url:s}},async deleteItemImage(e){try{let{data:t}=await y.O.from("inventory_files").select("file_path").eq("item_id",e),a=(t||[]).map(e=>e.file_path);a.length>0&&(await y.O.storage.from(B).remove(a),await y.O.from("inventory_files").delete().eq("item_id",e)),await this.updateItem(e,{thumbnail_url:null})}catch(e){throw console.error("Error deleting item image:",e),e}},async deleteItem(e){try{let{data:t}=await y.O.from("inventory_files").select("file_path").eq("item_id",e),a=(t||[]).map(e=>e.file_path);a.length>0&&await y.O.storage.from(B).remove(a)}catch(t){console.warn("Storage cleanup failed for item",e,t)}let{error:t}=await y.O.from("inventory_items").delete().eq("id",e);if(t)throw t}};var Y=a(2160),W=a(2913);let Q=Y.Ry({name:Y.Z_().min(1,"El nombre es requerido"),unit_value:Y.dj(e=>{if(""===e||null==e)return;let t="string"==typeof e?e:String(e),a=t.replace(/[^0-9]/g,"");return""===a?void 0:Number(a)},Y.Rx().min(0,"El valor debe ser positivo").optional()),package_value:Y.dj(e=>{if(""===e||null==e)return;let t="string"==typeof e?e:String(e),a=t.replace(/[^0-9]/g,"");return""===a?void 0:Number(a)},Y.Rx().min(0,"El valor del paquete debe ser positivo").optional()),use_package:Y.O7().optional(),description:Y.Z_().optional(),initial_quantity:Y.oQ.number().min(0,"La cantidad debe ser positiva").optional()});function AddItemForm(e){var t;let{projectId:a,onSuccess:r}=e,[i,n]=(0,l.useState)(!1),[o,c]=(0,l.useState)(null),[d,m]=(0,l.useState)(null),[x,u]=(0,l.useState)(""),[g,v]=(0,l.useState)(""),{register:y,handleSubmit:N,formState:{errors:w},reset:_,watch:C,setValue:k}=(0,f.cI)({resolver:(0,j.F)(Q)}),E=C("use_package"),S=C("initial_quantity"),O=C("package_value"),z=E&&S&&S>0&&O&&O>0?Math.round(O/S):void 0,D=y("use_package");y("unit_value"),y("package_value");let formatNumber=e=>{let t=e.replace(/\D/g,"");return t.length>3?t.replace(/\B(?=(\d{3})+(?!\d))/g,"."):t},onSubmit=async e=>{n(!0),c(null);try{let t=e.unit_value;if(e.use_package){if(!e.initial_quantity||e.initial_quantity<=0)throw Error('Para calcular valor unitario desde paquete, ingresa "Ingresar Cantidad inicial" mayor a 0.');if(!e.package_value||e.package_value<=0)throw Error('Ingresa un "Valor del paquete" mayor a 0 o desactiva el modo paquete.');t=e.package_value/e.initial_quantity}let s=await G.createItem(a,{name:e.name,description:e.description,unit_value:t});d&&await G.replaceItemImage(s.id,d),e.initial_quantity&&e.initial_quantity>0&&await G.createMovement(s.id,a,{quantity:e.initial_quantity,from_state:"externo",to_state:"bodega",note:"Ingreso inicial al inventario"}),_(),m(null),u(""),v(""),null==r||r()}catch(e){c(e.message||"Error al crear el producto")}finally{n(!1)}};return(0,s.jsxs)(p.Zb,{children:[(0,s.jsxs)(p.Ol,{children:[(0,s.jsxs)(p.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(W.Z,{className:"h-5 w-5"}),"Agregar Producto"]}),(0,s.jsx)(p.SZ,{children:"Crea un nuevo producto en el inventario"})]}),(0,s.jsx)(p.aY,{children:(0,s.jsxs)("form",{onSubmit:N(onSubmit),className:"space-y-4",children:[o&&(0,s.jsx)("div",{className:"p-3 text-sm text-destructive bg-destructive/10 border border-destructive/20 rounded-md",children:o}),(0,s.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{htmlFor:"name",className:"text-sm font-medium text-center block",children:"Nombre *"}),(0,s.jsx)(I.I,{id:"name",...y("name"),error:null===(t=w.name)||void 0===t?void 0:t.message,className:"text-center"})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[E?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("label",{htmlFor:"package_value",className:"text-sm font-medium text-center block",children:"Valor del paquete"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("span",{className:"absolute left-3 top-3 text-sm text-muted-foreground",children:"$"}),(0,s.jsx)("input",{id:"package_value",type:"text",placeholder:"100.000",className:"flex h-10 w-full rounded-md border border-input bg-background py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",style:{textAlign:"center",paddingLeft:"32px",paddingRight:"32px"},value:g,onChange:e=>{let t=e.target.value,a=formatNumber(t);v(a);let s=parseInt(a.replace(/\./g,""))||0;k("package_value",s,{shouldValidate:!0})}})]}),(0,s.jsx)("p",{className:"text-xs text-muted-foreground text-center",children:"Formato autom\xe1tico (ej: 100.000)"}),w.package_value&&(0,s.jsx)("p",{className:"text-sm text-destructive text-center",children:w.package_value.message}),void 0!==z&&(0,s.jsxs)("p",{className:"text-xs text-center text-gray-500",children:["Se guardar\xe1 unitario: $",new Intl.NumberFormat("es-CO").format(z)]})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("label",{htmlFor:"unit_value",className:"text-sm font-medium text-center block",children:"Valor Unitario (Opcional)"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("span",{className:"absolute left-3 top-3 text-sm text-muted-foreground",children:"$"}),(0,s.jsx)("input",{id:"unit_value",type:"text",placeholder:"100.000",className:"flex h-10 w-full rounded-md border border-input bg-background py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",style:{textAlign:"center",paddingLeft:"32px",paddingRight:"32px"},value:x,onChange:e=>{let t=e.target.value,a=formatNumber(t);u(a);let s=parseInt(a.replace(/\./g,""))||0;k("unit_value",s,{shouldValidate:!0})}})]}),(0,s.jsx)("p",{className:"text-xs text-muted-foreground text-center",children:"Formato autom\xe1tico (ej: 100.000)"}),w.unit_value&&(0,s.jsx)("p",{className:"text-sm text-destructive text-center",children:w.unit_value.message})]}),(0,s.jsxs)("div",{className:"flex items-center justify-center gap-2 pt-1",children:[(0,s.jsx)("input",{id:"use_package",type:"checkbox",...D,onChange:e=>{D.onChange(e),c(null);let t=e.target.checked;if(t){let e=C("unit_value");e&&e>0&&(k("package_value",e),v(x),k("unit_value",void 0),u(""))}else{let e=C("package_value");e&&e>0&&(k("unit_value",e),u(g)),k("package_value",void 0),v("")}}}),(0,s.jsx)("label",{htmlFor:"use_package",className:"text-xs text-gray-600",children:"Usar valor por paquete"})]})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{htmlFor:"initial_quantity",className:"text-sm font-medium text-center block",children:"Ingresar Cantidad inicial (Opcional)"}),(0,s.jsx)(I.I,{id:"initial_quantity",type:"number",placeholder:"0",className:"text-center",min:"0",...y("initial_quantity")}),(0,s.jsx)("p",{className:"text-xs text-muted-foreground text-center",children:"Esta cantidad se ingresar\xe1 autom\xe1ticamente a bodega"}),w.initial_quantity&&(0,s.jsx)("p",{className:"text-sm text-destructive text-center",children:w.initial_quantity.message})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{htmlFor:"image",className:"text-sm font-medium text-center block",children:"Imagen (Opcional)"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("input",{id:"image",type:"file",accept:"image/*",onChange:e=>{var t;return m((null===(t=e.target.files)||void 0===t?void 0:t[0])||null)},className:"hidden"}),(0,s.jsxs)(h.z,{type:"button",variant:"outline",className:"w-full",onClick:()=>{var e;return null===(e=document.getElementById("image"))||void 0===e?void 0:e.click()},children:[(0,s.jsx)(b.Z,{className:"h-4 w-4 mr-2"}),d?d.name:"Seleccionar Imagen"]})]}),d&&(0,s.jsxs)("p",{className:"text-xs text-green-600 text-center",children:["✓ ",d.name]})]})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{htmlFor:"description",className:"text-sm font-medium text-center block",children:"Descripci\xf3n (Opcional)"}),(0,s.jsx)("textarea",{id:"description",className:"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-3 text-sm text-center ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 resize-none",placeholder:"Detalles del producto, proveedor, especificaciones t\xe9cnicas...",...y("description")})]}),(0,s.jsx)(h.z,{type:"submit",className:"w-full",loading:i,children:"Agregar Producto"})]})})]})}var $=a(8438),K=a(3523),H=a(9617);function ImageModal(e){let{isOpen:t,onClose:a,imageUrl:r,itemName:i,itemId:n,onImageUpdated:o}=e,[c,d]=(0,l.useState)(!1),[m,x]=(0,l.useState)(!1),u=useConfirm(),{error:g}=(0,D.useToast)();if(!t)return null;let handleDeleteImage=async()=>{let e=await u.confirm({title:"Eliminar Imagen",message:"\xbfEst\xe1s seguro de que quieres eliminar esta imagen? Esta acci\xf3n no se puede deshacer.",confirmText:"Eliminar",cancelText:"Cancelar",variant:"danger"});if(e){x(!0);try{await G.deleteItemImage(n),null==o||o(),a()}catch(e){console.error("Error al eliminar imagen:",e),g("Error al eliminar la imagen")}finally{x(!1)}}};return(0,s.jsxs)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4",children:[(0,s.jsxs)("div",{className:"bg-white rounded-lg max-w-4xl max-h-[95vh] sm:max-h-[90vh] w-full flex flex-col",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between p-4 border-b",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:i}),(0,s.jsx)(h.z,{variant:"ghost",size:"sm",onClick:a,children:(0,s.jsx)(v.Z,{className:"h-5 w-5"})})]}),(0,s.jsx)("div",{className:"flex-1 flex items-center justify-center p-4 overflow-hidden",children:(0,s.jsx)("img",{src:r,alt:i,className:"max-w-full max-h-full object-contain rounded-lg shadow-lg"})}),(0,s.jsxs)("div",{className:"flex items-center justify-center gap-3 p-4 border-t bg-gray-50",children:[(0,s.jsxs)(h.z,{variant:"outline",onClick:()=>{let e=document.createElement("input");e.type="file",e.accept="image/*",e.onchange=async e=>{let t=e.target.files;if(t&&0!==t.length){d(!0);try{await G.replaceItemImage(n,t[0]),null==o||o(),a()}catch(e){console.error("Error al reemplazar imagen:",e),g("Error al reemplazar la imagen")}finally{d(!1)}}},e.click()},disabled:c,className:"flex items-center gap-2",children:[(0,s.jsx)(b.Z,{className:"h-4 w-4"}),c?"Subiendo...":"Reemplazar Imagen"]}),(0,s.jsxs)(h.z,{variant:"danger",onClick:handleDeleteImage,disabled:m,className:"flex items-center gap-2",children:[(0,s.jsx)(O.Z,{className:"h-4 w-4"}),m?"Eliminando...":"Eliminar Imagen"]})]})]}),(0,s.jsx)(ConfirmModal,{isOpen:u.isOpen,onClose:u.handleCancel,onConfirm:u.handleConfirm,title:u.options.title,message:u.options.message,confirmText:u.options.confirmText,cancelText:u.options.cancelText,variant:u.options.variant})]})}let J=Y.Ry({name:Y.Z_().min(1,"El nombre es requerido"),description:Y.Z_().optional(),unit_value:Y.dj(e=>{if(""===e||null==e)return;let t="string"==typeof e?e:String(e),a=t.replace(/[^0-9]/g,"");return""===a?void 0:Number(a)},Y.Rx().min(0,"El valor debe ser positivo").optional())});function EditItemModal(e){var t;let{item:a,isOpen:r,onClose:i,onSuccess:n}=e,[o,c]=(0,l.useState)(!1),[d,m]=(0,l.useState)(null),[x,u]=(0,l.useState)(""),{register:g,handleSubmit:p,formState:{errors:b},reset:v,setValue:y}=(0,f.cI)({resolver:(0,j.F)(J)}),formatNumber=e=>{let t=e.replace(/\D/g,"");return t.length>3?t.replace(/\B(?=(\d{3})+(?!\d))/g,"."):t};(0,l.useEffect)(()=>{a&&r&&(v({name:a.name,description:a.description||"",unit_value:a.unit_value||void 0}),u(a.unit_value?new Intl.NumberFormat("es-CO").format(a.unit_value):""),m(null))},[a,r,v]);let onSubmit=async e=>{if(a){c(!0),m(null);try{await G.updateItem(a.id,{name:e.name,description:e.description,unit_value:e.unit_value}),n(),i()}catch(e){m(e.message||"Error al actualizar el producto")}finally{c(!1)}}};return r&&a?(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:(0,s.jsx)("div",{className:"bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto",children:(0,s.jsxs)("div",{className:"p-6",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-4",children:[(0,s.jsx)(H.Z,{className:"h-5 w-5"}),(0,s.jsx)("h2",{className:"text-xl font-semibold",children:"Editar Producto"})]}),(0,s.jsxs)("form",{onSubmit:p(onSubmit),className:"space-y-4",children:[d&&(0,s.jsx)("div",{className:"p-3 text-sm text-destructive bg-destructive/10 border border-destructive/20 rounded-md",children:d}),(0,s.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{htmlFor:"edit-name",className:"text-sm font-medium block",children:"Nombre *"}),(0,s.jsx)(I.I,{id:"edit-name",...g("name"),error:null===(t=b.name)||void 0===t?void 0:t.message})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{htmlFor:"edit-unit-value",className:"text-sm font-medium block",children:"Valor Unitario (Opcional)"}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("span",{className:"absolute left-3 top-3 text-sm text-muted-foreground",children:"$"}),(0,s.jsx)("input",{id:"edit-unit-value",type:"text",placeholder:"100.000",className:"flex h-10 w-full rounded-md border border-input bg-background py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",style:{textAlign:"center",paddingLeft:"32px",paddingRight:"32px"},value:x,onChange:e=>{let t=e.target.value,a=formatNumber(t);u(a);let s=parseInt(a.replace(/\./g,""))||0;y("unit_value",s,{shouldValidate:!0})}})]}),(0,s.jsx)("p",{className:"text-xs text-muted-foreground",children:"Formato autom\xe1tico (ej: 100.000)"}),b.unit_value&&(0,s.jsx)("p",{className:"text-sm text-destructive",children:b.unit_value.message})]})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("label",{htmlFor:"edit-description",className:"text-sm font-medium block",children:"Descripci\xf3n (Opcional)"}),(0,s.jsx)("textarea",{id:"edit-description",className:"flex min-h-[100px] w-full rounded-md border border-input bg-background px-3 py-3 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 resize-none",placeholder:"Detalles del producto, proveedor, especificaciones t\xe9cnicas...",...g("description")})]}),(0,s.jsxs)("div",{className:"flex gap-3 justify-end pt-4",children:[(0,s.jsx)(h.z,{type:"button",variant:"ghost",onClick:i,disabled:o,children:"Cancelar"}),(0,s.jsx)(h.z,{type:"submit",loading:o,children:"Guardar Cambios"})]})]})]})})}):null}function InventoryList(e){let{projectId:t,items:a,onUpdate:r}=e,[i,n]=(0,l.useState)(null),[o,c]=(0,l.useState)({}),[d,m]=(0,l.useState)({}),[x,u]=(0,l.useState)(null),[g,f]=(0,l.useState)({}),[j,v]=(0,l.useState)({isOpen:!1,imageUrl:"",itemName:"",itemId:""}),[y,N]=(0,l.useState)(null),[w,_]=(0,l.useState)(""),[C,k]=(0,l.useState)(null),E=useConfirm(),{toasts:S,removeToast:z,error:U}=(0,D.useToast)(),Z=(0,l.useMemo)(()=>a.reduce((e,t)=>(e.bodega+=t.qty_bodega,e.uso+=t.qty_uso,e.gastado+=t.qty_gastado,e),{bodega:0,uso:0,gastado:0}),[a]),P=(0,l.useMemo)(()=>a.reduce((e,t)=>{var a;let s=t.qty_bodega+t.qty_uso;return e+(null!==(a=t.unit_value)&&void 0!==a?a:0)*s},0),[a]),formatNumber=e=>{let t=e.replace(/\D/g,"");return t.length>3?t.replace(/\B(?=(\d{3})+(?!\d))/g,"."):t},startEditingUnitValue=(e,t)=>{N(e),_(t?new Intl.NumberFormat("es-CO").format(t):"")},handleUnitValueChange=e=>{let t=e.target.value,a=formatNumber(t);_(a)},saveUnitValue=async e=>{try{let t=w?parseInt(w.replace(/\./g,"")):null;await G.updateItem(e,{unit_value:t}),N(null),_(""),null==r||r()}catch(e){U(e.message||"Error al actualizar el valor unitario")}},cancelEditingUnitValue=()=>{N(null),_("")},triggerReplaceImage=e=>{let t=document.createElement("input");t.type="file",t.multiple=!1,t.accept="image/*",t.onchange=async t=>{let a=t.target.files;if(a&&0!==a.length){n(e);try{await G.replaceItemImage(e,a[0]),null==r||r()}finally{n(null)}}},t.click()},handleDelete=async e=>{let t=await E.confirm({title:"Eliminar Producto",message:"\xbfEst\xe1s seguro de que quieres eliminar este producto? Esta acci\xf3n no se puede deshacer.",confirmText:"Eliminar",cancelText:"Cancelar",variant:"danger"});if(t){u(e);try{await G.deleteItem(e),null==r||r()}catch(e){U(e.message||"Error al eliminar el producto")}finally{u(null)}}},getThumbUrl=e=>{var t;if(e.thumbnail_url)return e.thumbnail_url;let a=null===(t=e.files)||void 0===t?void 0:t.find(e=>(e.file_type||"").startsWith("image/"));return a?G.getFileUrl(a.file_path):""},openImageModal=e=>{let t=getThumbUrl(e);t&&v({isOpen:!0,imageUrl:t,itemName:e.name,itemId:e.id})},ensureQtyState=e=>{d[e]||m(t=>({...t,[e]:{add:"",toUse:"",toSpent:""}}))},updateQtyInput=(e,t,a)=>{m(s=>({...s,[e]:{...s[e]||{add:"",toUse:"",toSpent:""},[t]:a}}))},move=async(e,a)=>{ensureQtyState(e.id);let s=d[e.id]||{add:"",toUse:"",toSpent:""},l="add"===a?s.add:"toUse"===a?s.toUse:s.toSpent,i=parseInt(l,10);if(!i||i<=0){U("Ingresa una cantidad v\xe1lida");return}try{if("add"===a)await G.createMovement(e.id,t,{quantity:i,from_state:"externo",to_state:"bodega"});else if("toUse"===a){if(i>e.qty_bodega){U("Cantidad supera lo disponible en bodega");return}await G.createMovement(e.id,t,{quantity:i,from_state:"bodega",to_state:"uso"})}else{if(i>e.qty_uso){U("Cantidad supera lo disponible en uso");return}await G.createMovement(e.id,t,{quantity:i,from_state:"uso",to_state:"gastado"})}null==r||r(),m(t=>({...t,[e.id]:{add:"",toUse:"",toSpent:""}}))}catch(e){U(e.message||"Error al registrar movimiento")}};return 0===a.length?(0,s.jsx)(p.Zb,{children:(0,s.jsx)(p.aY,{className:"py-12",children:(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center text-gray-500",children:[(0,s.jsx)(b.Z,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),(0,s.jsx)("p",{className:"text-lg font-medium",children:"No hay productos en inventario"}),(0,s.jsx)("p",{className:"text-sm mt-1",children:"Comienza agregando productos al inventario"})]})})}):(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)(p.Zb,{children:[(0,s.jsxs)(p.Ol,{children:[(0,s.jsx)(p.ll,{children:"Resumen del Inventario"}),(0,s.jsx)(p.SZ,{children:"Tabla por producto y cantidades por estado"})]}),(0,s.jsx)(p.aY,{children:(0,s.jsx)("div",{className:"overflow-x-auto -mx-4 sm:mx-0",children:(0,s.jsxs)("table",{className:"min-w-full text-xs sm:text-sm border",children:[(0,s.jsx)("thead",{children:(0,s.jsxs)("tr",{className:"bg-gray-50 text-gray-700",children:[(0,s.jsx)("th",{className:"text-center p-2 border",children:"Producto"}),(0,s.jsx)("th",{className:"text-center p-2 border",children:"Valor unitario"}),(0,s.jsx)("th",{className:"text-center p-2 border",children:"En bodega"}),(0,s.jsx)("th",{className:"text-center p-2 border",children:"En uso"}),(0,s.jsx)("th",{className:"text-center p-2 border",children:"Gastado"}),(0,s.jsx)("th",{className:"text-center p-2 border",children:"Total"}),(0,s.jsx)("th",{className:"text-center p-2 border",children:"Valor total (stock)"})]})}),(0,s.jsxs)("tbody",{children:[a.map(e=>{var t;let a=e.qty_bodega+e.qty_uso+e.qty_gastado,r=e.qty_bodega+e.qty_uso,l=(null!==(t=e.unit_value)&&void 0!==t?t:0)*r;return(0,s.jsxs)("tr",{className:"odd:bg-white even:bg-gray-50",children:[(0,s.jsx)("td",{className:"p-2 border text-center",children:e.name}),(0,s.jsx)("td",{className:"p-2 border text-center",children:y===e.id?(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[(0,s.jsxs)("div",{className:"relative flex-1",children:[(0,s.jsx)("span",{className:"absolute left-1 top-1 text-xs text-muted-foreground",children:"$"}),(0,s.jsx)("input",{type:"text",className:"w-full text-xs border rounded px-1 py-1 text-center",style:{paddingLeft:"12px",paddingRight:"12px"},value:w,onChange:handleUnitValueChange,onKeyDown:t=>{"Enter"===t.key&&saveUnitValue(e.id),"Escape"===t.key&&cancelEditingUnitValue()},autoFocus:!0})]}),(0,s.jsx)("button",{onClick:()=>saveUnitValue(e.id),className:"text-xs text-green-600 hover:text-green-800",title:"Guardar",children:"✓"}),(0,s.jsx)("button",{onClick:cancelEditingUnitValue,className:"text-xs text-red-600 hover:text-red-800",title:"Cancelar",children:"✕"})]}):(0,s.jsx)("button",{onClick:()=>startEditingUnitValue(e.id,e.unit_value),className:"text-blue-600 hover:text-blue-800 hover:underline cursor-pointer",title:"Click para editar valor unitario",children:null!=e.unit_value?formatCurrency(e.unit_value):"Agregar valor"})}),(0,s.jsx)("td",{className:"p-2 border text-center",children:e.qty_bodega}),(0,s.jsx)("td",{className:"p-2 border text-center",children:e.qty_uso}),(0,s.jsx)("td",{className:"p-2 border text-center",children:e.qty_gastado}),(0,s.jsx)("td",{className:"p-2 border text-center font-medium",children:a}),(0,s.jsx)("td",{className:"p-2 border text-center font-medium",children:null!=e.unit_value?formatCurrency(l):"-"})]},"sum-".concat(e.id))}),0===a.length&&(0,s.jsx)("tr",{children:(0,s.jsx)("td",{className:"p-2 border text-center text-gray-500",colSpan:7,children:"Sin datos"})})]}),(0,s.jsx)("tfoot",{children:(0,s.jsxs)("tr",{className:"bg-gray-100 font-semibold",children:[(0,s.jsx)("td",{className:"p-2 border text-center",children:"Totales"}),(0,s.jsx)("td",{className:"p-2 border text-center",children:"-"}),(0,s.jsx)("td",{className:"p-2 border text-center",children:Z.bodega}),(0,s.jsx)("td",{className:"p-2 border text-center",children:Z.uso}),(0,s.jsx)("td",{className:"p-2 border text-center",children:Z.gastado}),(0,s.jsx)("td",{className:"p-2 border text-center",children:Z.bodega+Z.uso+Z.gastado}),(0,s.jsx)("td",{className:"p-2 border text-center",children:formatCurrency(P)})]})})]})})})]}),(0,s.jsx)("div",{className:"space-y-4",children:a.map(e=>{var t,a,r,l;return(0,s.jsx)(p.Zb,{children:(0,s.jsx)(p.aY,{className:"pt-4 sm:pt-6",children:(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row gap-4",children:[(0,s.jsx)("div",{className:"w-16 h-16 sm:w-20 sm:h-20 rounded-md border bg-gray-50 flex items-center justify-center overflow-hidden transition-colors flex-shrink-0 ".concat(getThumbUrl(e)?"cursor-pointer hover:border-gray-300":""),onClick:()=>getThumbUrl(e)&&openImageModal(e),title:getThumbUrl(e)?"Click para ver imagen completa":"Sin imagen",children:getThumbUrl(e)?(0,s.jsx)("img",{src:getThumbUrl(e),alt:e.name,className:"w-full h-full object-cover"}):(0,s.jsx)($.Z,{className:"h-6 w-6 sm:h-8 sm:w-8 text-gray-400"})}),(0,s.jsxs)("div",{className:"flex-1 min-w-0 relative",children:[(0,s.jsxs)("div",{className:"flex flex-wrap items-start justify-end gap-1 sm:gap-2 mb-2 sm:mb-0 sm:absolute sm:top-0 sm:right-0",children:[(0,s.jsxs)(h.z,{variant:"ghost",size:"sm",onClick:()=>f(t=>({...t,[e.id]:!t[e.id]})),children:[(0,s.jsx)("span",{className:"hidden sm:inline",children:g[e.id]?"Ocultar movimientos":"Movimientos"}),(0,s.jsx)("span",{className:"sm:hidden text-xs",children:g[e.id]?"Ocultar":"Movimientos"})]}),(0,s.jsxs)(h.z,{variant:"ghost",size:"sm",onClick:()=>triggerReplaceImage(e.id),disabled:i===e.id,children:[(0,s.jsx)(b.Z,{className:"h-4 w-4 sm:mr-1"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:i===e.id?"Subiendo...":"Reemplazar imagen"})]}),(0,s.jsx)(h.z,{variant:"ghost",size:"sm",onClick:()=>c(t=>({...t,[e.id]:!t[e.id]})),children:(0,s.jsx)(K.Z,{className:"h-4 w-4 transition-transform ".concat(o[e.id]?"rotate-180":"")})}),(0,s.jsx)(h.z,{variant:"ghost",size:"sm",className:"text-blue-600 hover:text-blue-800 hover:bg-blue-50",onClick:()=>k(e),title:"Editar producto",children:(0,s.jsx)(H.Z,{className:"h-4 w-4"})}),(0,s.jsx)(h.z,{variant:"ghost",size:"sm",className:"text-red-600 hover:text-red-800 hover:bg-red-50",onClick:()=>handleDelete(e.id),disabled:x===e.id,title:"Eliminar producto",children:(0,s.jsx)(O.Z,{className:"h-4 w-4"})})]}),(0,s.jsxs)("div",{className:"sm:pr-2",children:[(0,s.jsx)("p",{className:"font-semibold text-gray-900 sm:max-w-[calc(100%-34rem)]",children:e.name}),e.description&&(0,s.jsx)("p",{className:"text-sm text-gray-500 mt-1 break-words sm:max-w-[calc(100%-34rem)]",children:e.description}),(0,s.jsx)("div",{className:"mt-1",children:y===e.id?(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("span",{className:"text-sm font-medium text-gray-600",children:"Valor unitario:"}),(0,s.jsxs)("div",{className:"relative flex-1 max-w-[200px]",children:[(0,s.jsx)("span",{className:"absolute left-2 top-1 text-xs text-muted-foreground",children:"$"}),(0,s.jsx)("input",{type:"text",className:"w-full text-sm border rounded px-2 py-1 text-center",style:{paddingLeft:"20px",paddingRight:"20px"},value:w,onChange:handleUnitValueChange,onKeyDown:t=>{"Enter"===t.key&&saveUnitValue(e.id),"Escape"===t.key&&cancelEditingUnitValue()},autoFocus:!0})]}),(0,s.jsx)("button",{onClick:()=>saveUnitValue(e.id),className:"text-sm text-green-600 hover:text-green-800",title:"Guardar",children:"✓"}),(0,s.jsx)("button",{onClick:cancelEditingUnitValue,className:"text-sm text-red-600 hover:text-red-800",title:"Cancelar",children:"✕"})]}):(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:[(0,s.jsx)("strong",{children:"Valor unitario:"})," ",(0,s.jsx)("button",{onClick:()=>startEditingUnitValue(e.id,e.unit_value),className:"text-blue-600 hover:text-blue-800 hover:underline cursor-pointer",title:"Click para editar valor unitario",children:null!=e.unit_value?formatCurrency(e.unit_value):"Agregar valor"})]})}),(0,s.jsxs)("div",{className:"flex flex-wrap gap-3 text-xs text-gray-500 mt-2",children:[(0,s.jsxs)("span",{children:[(0,s.jsx)("strong",{children:"Bodega:"})," ",e.qty_bodega]}),(0,s.jsxs)("span",{children:[(0,s.jsx)("strong",{children:"En uso:"})," ",e.qty_uso]}),(0,s.jsxs)("span",{children:[(0,s.jsx)("strong",{children:"Gastado:"})," ",e.qty_gastado]})]})]}),g[e.id]&&(0,s.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 mt-4",children:[(0,s.jsxs)("div",{className:"p-3 rounded-lg border bg-gray-50",children:[(0,s.jsx)("p",{className:"text-xs font-medium text-gray-600 mb-2",children:"Ingresar a bodega"}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(I.I,{type:"number",min:1,placeholder:"Cantidad",value:(null===(t=d[e.id])||void 0===t?void 0:t.add)||"",onChange:t=>updateQtyInput(e.id,"add",t.target.value)}),(0,s.jsx)(h.z,{size:"sm",onClick:()=>move(e,"add"),children:"Ingresar"})]})]}),(0,s.jsxs)("div",{className:"p-3 rounded-lg border bg-gray-50",children:[(0,s.jsx)("p",{className:"text-xs font-medium text-gray-600 mb-2",children:"Mover a En uso"}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(I.I,{type:"number",min:1,max:e.qty_bodega,placeholder:"Max ".concat(e.qty_bodega),value:(null===(a=d[e.id])||void 0===a?void 0:a.toUse)||"",onChange:t=>updateQtyInput(e.id,"toUse",t.target.value)}),(0,s.jsx)(h.z,{size:"sm",onClick:()=>move(e,"toUse"),children:"Mover"})]})]}),(0,s.jsxs)("div",{className:"p-3 rounded-lg border bg-gray-50",children:[(0,s.jsx)("p",{className:"text-xs font-medium text-gray-600 mb-2",children:"Marcar Gastado"}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(I.I,{type:"number",min:1,max:e.qty_uso,placeholder:"Max ".concat(e.qty_uso),value:(null===(r=d[e.id])||void 0===r?void 0:r.toSpent)||"",onChange:t=>updateQtyInput(e.id,"toSpent",t.target.value)}),(0,s.jsx)(h.z,{size:"sm",onClick:()=>move(e,"toSpent"),children:"Gastar"})]})]})]}),o[e.id]&&(0,s.jsxs)("div",{className:"mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3",children:[null===(l=e.files)||void 0===l?void 0:l.map(e=>{var t;return(0,s.jsxs)("div",{className:"border rounded-md overflow-hidden bg-white",children:[(null===(t=e.file_type)||void 0===t?void 0:t.startsWith("image/"))?(0,s.jsx)("img",{src:G.getFileUrl(e.file_path),alt:e.file_name,className:"w-full h-28 object-cover"}):(0,s.jsx)("div",{className:"h-28 flex items-center justify-center text-xs text-gray-500 p-2",children:e.file_name}),(0,s.jsx)("div",{className:"p-2 text-xs text-gray-600 truncate",title:e.file_name,children:e.file_name})]},e.id)}),(!e.files||0===e.files.length)&&(0,s.jsx)("div",{className:"col-span-full text-xs text-gray-500",children:"Sin archivos"})]})]})]})})},e.id)})}),(0,s.jsx)(ImageModal,{isOpen:j.isOpen,onClose:()=>{v({isOpen:!1,imageUrl:"",itemName:"",itemId:""})},imageUrl:j.imageUrl,itemName:j.itemName,itemId:j.itemId,onImageUpdated:r}),(0,s.jsx)(EditItemModal,{item:C,isOpen:!!C,onClose:()=>k(null),onSuccess:()=>{null==r||r(),k(null)}}),(0,s.jsx)(ConfirmModal,{isOpen:E.isOpen,onClose:E.handleCancel,onConfirm:E.handleConfirm,title:E.options.title,message:E.options.message,confirmText:E.options.confirmText,cancelText:E.options.cancelText,variant:E.options.variant})]})}var X=a(5253),ee=a(5223),et=a(7460),ea=a(6612),es=a(6531),er=a(229),el=a(5064),ei=a(6573),en=a(4235),eo=a(8656),ec=a(2),ed=a(4322);function InventoryChart(e){let{items:t,showSummary:a=!0,showCharts:r=!0}=e,i=(0,l.useMemo)(()=>{if(!t||0===t.length)return null;let e=0,a=0,s=0,r=0,l=0,i=t.filter(e=>e.unit_value&&e.unit_value>0).map(t=>{let r=t.qty_bodega+t.qty_uso,l=(t.unit_value||0)*r;return e+=(t.unit_value||0)*t.qty_bodega,a+=(t.unit_value||0)*t.qty_uso,s+=(t.unit_value||0)*t.qty_gastado,{name:t.name.length>15?t.name.substring(0,15)+"...":t.name,fullName:t.name,value:l,unitValue:t.unit_value,stock:r,bodega:t.qty_bodega,uso:t.qty_uso,gastado:t.qty_gastado}}).sort((e,t)=>t.value-e.value).slice(0,8);t.forEach(e=>{e.unit_value&&e.unit_value>0?r++:l++});let n=[{name:"En Bodega",value:e,color:"#10B981",count:t.reduce((e,t)=>e+t.qty_bodega,0)},{name:"En Uso",value:a,color:"#3B82F6",count:t.reduce((e,t)=>e+t.qty_uso,0)},{name:"Gastado",value:s,color:"#EF4444",count:t.reduce((e,t)=>e+t.qty_gastado,0)}].filter(e=>e.value>0),o=[{name:"Con Valor",value:r,color:"#10B981"},{name:"Sin Valor",value:l,color:"#9CA3AF"}].filter(e=>e.value>0),c=e+a+s,d=e+a;return{stateData:n,valuationData:o,itemsWithValueData:i,totalValue:c,stockValue:d,totalItems:t.length,itemsWithValue:r,itemsWithoutValue:l}},[t]);return i&&0!==t.length?(0,s.jsxs)("div",{className:"space-y-6",children:[a&&(0,s.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:[(0,s.jsxs)(p.Zb,{children:[(0,s.jsx)(p.Ol,{className:"pb-2",children:(0,s.jsxs)(p.ll,{className:"text-sm font-medium text-gray-600 flex items-center gap-2",children:[(0,s.jsx)(o.Z,{className:"h-4 w-4 text-green-600"}),"Valor Total Stock"]})}),(0,s.jsxs)(p.aY,{children:[(0,s.jsx)("div",{className:"text-2xl font-bold text-green-600",children:formatCurrency(i.stockValue)}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Bodega + En Uso"})]})]}),(0,s.jsxs)(p.Zb,{children:[(0,s.jsx)(p.Ol,{className:"pb-2",children:(0,s.jsxs)(p.ll,{className:"text-sm font-medium text-gray-600 flex items-center gap-2",children:[(0,s.jsx)(d.Z,{className:"h-4 w-4 text-blue-600"}),"Total Items"]})}),(0,s.jsxs)(p.aY,{children:[(0,s.jsx)("div",{className:"text-2xl font-bold text-blue-600",children:i.totalItems}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Productos registrados"})]})]}),(0,s.jsxs)(p.Zb,{children:[(0,s.jsx)(p.Ol,{className:"pb-2",children:(0,s.jsxs)(p.ll,{className:"text-sm font-medium text-gray-600 flex items-center gap-2",children:[(0,s.jsx)(ed.Z,{className:"h-4 w-4 text-purple-600"}),"Con Valor"]})}),(0,s.jsxs)(p.aY,{children:[(0,s.jsx)("div",{className:"text-2xl font-bold text-purple-600",children:i.itemsWithValue}),(0,s.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:[Math.round(i.itemsWithValue/i.totalItems*100),"% del total"]})]})]}),(0,s.jsxs)(p.Zb,{children:[(0,s.jsx)(p.Ol,{className:"pb-2",children:(0,s.jsxs)(p.ll,{className:"text-sm font-medium text-gray-600 flex items-center gap-2",children:[(0,s.jsx)(z.Z,{className:"h-4 w-4 text-orange-600"}),"Sin Valor"]})}),(0,s.jsxs)(p.aY,{children:[(0,s.jsx)("div",{className:"text-2xl font-bold text-orange-600",children:i.itemsWithoutValue}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"Requieren valoraci\xf3n"})]})]})]}),r&&(0,s.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6",children:[(0,s.jsxs)(p.Zb,{children:[(0,s.jsx)(p.Ol,{children:(0,s.jsxs)(p.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(d.Z,{className:"h-5 w-5 text-blue-600"}),"Distribuci\xf3n de Valor por Estado"]})}),(0,s.jsx)(p.aY,{children:i.stateData.length>0?(0,s.jsx)("div",{className:"h-80",children:(0,s.jsx)(X.h,{width:"100%",height:"100%",children:(0,s.jsxs)(ee.u,{children:[(0,s.jsx)(et.b,{data:i.stateData,cx:"50%",cy:"50%",innerRadius:60,outerRadius:100,paddingAngle:5,dataKey:"value",children:i.stateData.map((e,t)=>(0,s.jsx)(ea.b,{fill:e.color},"cell-".concat(t)))}),(0,s.jsx)(es.u,{content:(0,s.jsx)(e=>{let{active:t,payload:a}=e;if(t&&a&&a.length){let e=a[0].payload;return(0,s.jsxs)("div",{className:"bg-white p-3 border border-gray-200 rounded-lg shadow-lg",children:[(0,s.jsx)("p",{className:"font-medium",children:e.name}),(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:["Valor: ",(0,s.jsx)("span",{className:"font-medium",style:{color:e.color},children:formatCurrency(e.value)})]}),(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:["Cantidad: ",e.count," unidades"]})]})}return null},{})}),(0,s.jsx)(er.D,{formatter:(e,t)=>(0,s.jsxs)("span",{style:{color:t.color},children:[e,": ",formatCurrency(t.payload.value)]})})]})})}):(0,s.jsxs)("div",{className:"h-80 flex flex-col items-center justify-center text-gray-500",children:[(0,s.jsx)(d.Z,{className:"h-10 w-10 mb-2 text-gray-400"}),(0,s.jsx)("p",{className:"font-medium",children:"Sin valoraci\xf3n por estado"}),(0,s.jsx)("p",{className:"text-sm",children:"A\xfan no has ingresado valores unitarios"})]})})]}),(0,s.jsxs)(p.Zb,{children:[(0,s.jsx)(p.Ol,{children:(0,s.jsxs)(p.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(o.Z,{className:"h-5 w-5 text-green-600"}),"Items con Mayor Valor en Stock"]})}),(0,s.jsx)(p.aY,{children:i.itemsWithValueData.length>0?(0,s.jsx)("div",{className:"h-80",children:(0,s.jsx)(X.h,{width:"100%",height:"100%",children:(0,s.jsxs)(el.v,{data:i.itemsWithValueData,margin:{top:20,right:30,left:20,bottom:60},children:[(0,s.jsx)(ei.q,{strokeDasharray:"3 3"}),(0,s.jsx)(en.K,{dataKey:"name",angle:-45,textAnchor:"end",height:80,fontSize:12}),(0,s.jsx)(eo.Q,{tickFormatter:e=>formatCurrency(e).replace("$",""),fontSize:12}),(0,s.jsx)(es.u,{content:(0,s.jsx)(e=>{let{active:t,payload:a,label:r}=e;if(t&&a&&a.length){let e=a[0].payload;return(0,s.jsxs)("div",{className:"bg-white p-3 border border-gray-200 rounded-lg shadow-lg",children:[(0,s.jsx)("p",{className:"font-medium",children:e.fullName||r}),(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:["Valor Total: ",(0,s.jsx)("span",{className:"font-medium text-green-600",children:formatCurrency(e.value)})]}),(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:["Stock: ",e.stock," unidades"]}),(0,s.jsxs)("p",{className:"text-sm text-gray-600",children:["Valor Unitario: ",formatCurrency(e.unitValue)]})]})}return null},{})}),(0,s.jsx)(ec.$,{dataKey:"value",fill:"#10B981",radius:[4,4,0,0]})]})})}):(0,s.jsxs)("div",{className:"h-80 flex flex-col items-center justify-center text-gray-500",children:[(0,s.jsx)(o.Z,{className:"h-10 w-10 mb-2 text-gray-400"}),(0,s.jsx)("p",{className:"font-medium",children:"Sin productos valorados"}),(0,s.jsx)("p",{className:"text-sm",children:"Asigna valores unitarios para ver el top"})]})})]})]})]}):(0,s.jsx)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6",children:(0,s.jsxs)(p.Zb,{children:[(0,s.jsx)(p.Ol,{children:(0,s.jsxs)(p.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(d.Z,{className:"h-5 w-5 text-gray-400"}),"Valor del Inventario"]})}),(0,s.jsx)(p.aY,{children:(0,s.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,s.jsx)(ed.Z,{className:"h-12 w-12 mx-auto mb-3 text-gray-300"}),(0,s.jsx)("p",{children:"No hay items en el inventario"}),(0,s.jsx)("p",{className:"text-sm",children:"Agrega productos para ver las estad\xedsticas"})]})})]})})}function InventoryTab(e){let{projectId:t,userRole:a}=e,{success:r}=(0,D.useToast)(),[i,n]=(0,l.useState)(!0),[o,c]=(0,l.useState)(!1),[m,x]=(0,l.useState)([]),[u,p]=(0,l.useState)(""),[f,j]=(0,l.useState)(!1),b=(0,l.useRef)(null),load=async()=>{try{n(!0);let e=await G.getItemsWithQuantities(t);x(e)}catch(e){console.error("Error loading inventory:",e)}finally{n(!1)}},v=l.useMemo(()=>{let e=Array.from(new Set(m.map(e=>e.name)));if(!u)return e.slice(0,8);let t=u.toLowerCase();return e.filter(e=>e.toLowerCase().includes(t)).slice(0,8)},[m,u]),y=l.useMemo(()=>{if(!u)return m;let e=u.toLowerCase();return m.filter(t=>t.name.toLowerCase().includes(e))},[m,u]);return((0,l.useEffect)(()=>{let handler=e=>{b.current&&!b.current.contains(e.target)&&j(!1)};return document.addEventListener("mousedown",handler),()=>document.removeEventListener("mousedown",handler)},[]),(0,l.useEffect)(()=>{t&&load()},[t]),i)?(0,s.jsx)("div",{className:"flex items-center justify-center min-h-[300px]",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})}):(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4",children:[(0,s.jsxs)("h2",{className:"text-lg font-medium flex items-center gap-2",children:[(0,s.jsx)(d.Z,{className:"h-5 w-5"})," Inventario"]}),(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-4 sm:flex-1 sm:justify-end",children:[(0,s.jsxs)("div",{ref:b,className:"relative w-full sm:max-w-xs",children:[(0,s.jsx)(I.I,{placeholder:"Buscar producto...",value:u,onChange:e=>{p(e.target.value),j(!0)},onFocus:()=>j(!0)}),f&&v.length>0&&(0,s.jsx)("div",{className:"absolute z-10 mt-1 w-full bg-white border rounded-md shadow",children:v.map(e=>(0,s.jsx)("button",{type:"button",className:"w-full text-left px-3 py-2 hover:bg-gray-50 text-sm",onMouseDown:()=>{p(e),j(!1)},children:e},e))})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2 sm:gap-3",children:[u&&(0,s.jsx)(h.z,{variant:"ghost",size:"sm",onClick:()=>{p(""),j(!1)},children:"Limpiar"}),P.canEdit(a)&&(0,s.jsxs)(h.z,{onClick:()=>c(!o),className:"whitespace-nowrap",children:[(0,s.jsx)(g.Z,{className:"h-4 w-4 mr-2"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:o?"Cancelar":"Agregar Producto"}),(0,s.jsx)("span",{className:"sm:hidden",children:o?"Cancelar":"Agregar"})]})]})]})]}),o&&(0,s.jsx)(AddItemForm,{projectId:t,onSuccess:()=>{c(!1),load(),r("✅ Producto agregado exitosamente")}}),m.length>0&&(0,s.jsx)("div",{className:"mb-6",children:(0,s.jsx)(InventoryChart,{items:m,showCharts:!1})}),(0,s.jsx)(InventoryList,{projectId:t,items:y,onUpdate:load})]})}var em=a(5546),ex=a(525);function ExpenseChart(e){let{expenses:t,totalExpenses:a}=e,r=t.reduce((e,t)=>{let a=t.category||"Sin categor\xeda";return e[a]=(e[a]||0)+t.amount,e},{}),l=Object.entries(r).sort((e,t)=>{let[,a]=e,[,s]=t;return s-a}).slice(0,5),formatCurrency=e=>new Intl.NumberFormat("es-CO",{style:"currency",currency:"COP",minimumFractionDigits:0,maximumFractionDigits:0}).format(e),getPercentage=e=>a>0?(e/a*100).toFixed(1):"0",i=["bg-red-500","bg-orange-500","bg-yellow-500","bg-green-500","bg-blue-500"];return(0,s.jsxs)(p.Zb,{children:[(0,s.jsx)(p.Ol,{children:(0,s.jsxs)(p.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(ex.Z,{className:"h-5 w-5"}),"Gastos por Categor\xeda"]})}),(0,s.jsx)(p.aY,{children:0===l.length?(0,s.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,s.jsx)(n.Z,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),(0,s.jsx)("p",{children:"No hay gastos registrados"})]}):(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)("div",{className:"space-y-3",children:l.map((e,t)=>{let[a,r]=e;return(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center text-sm",children:[(0,s.jsx)("span",{className:"font-medium text-gray-700",children:a}),(0,s.jsxs)("span",{className:"text-gray-600",children:[formatCurrency(r)," (",getPercentage(r),"%)"]})]}),(0,s.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2",children:(0,s.jsx)("div",{className:"h-2 rounded-full ".concat(i[t%i.length]),style:{width:"".concat(getPercentage(r),"%")}})})]},a)})}),(0,s.jsx)("div",{className:"pt-4 border-t",children:(0,s.jsxs)("div",{className:"flex justify-between items-center font-semibold",children:[(0,s.jsx)("span",{children:"Total"}),(0,s.jsx)("span",{className:"text-red-600",children:formatCurrency(a)})]})})]})})]})}function IncomeChart(e){let{income:t,totalIncome:a}=e,r=t.reduce((e,t)=>{let a=t.category||"Sin categor\xeda";return e[a]=(e[a]||0)+t.amount,e},{}),l=Object.entries(r).sort((e,t)=>{let[,a]=e,[,s]=t;return s-a}).slice(0,5),formatCurrency=e=>new Intl.NumberFormat("es-CO",{style:"currency",currency:"COP",minimumFractionDigits:0,maximumFractionDigits:0}).format(e),getPercentage=e=>a>0?(e/a*100).toFixed(1):"0",i=["bg-green-500","bg-emerald-500","bg-teal-500","bg-cyan-500","bg-blue-500"];return(0,s.jsxs)(p.Zb,{children:[(0,s.jsx)(p.Ol,{children:(0,s.jsxs)(p.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(o.Z,{className:"h-5 w-5 text-green-600"}),"Ingresos por Categor\xeda"]})}),(0,s.jsx)(p.aY,{children:0===l.length?(0,s.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,s.jsx)(n.Z,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),(0,s.jsx)("p",{children:"No hay ingresos registrados"})]}):(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)("div",{className:"space-y-3",children:l.map((e,t)=>{let[a,r]=e;return(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center text-sm",children:[(0,s.jsx)("span",{className:"font-medium text-gray-700",children:a}),(0,s.jsxs)("span",{className:"text-gray-600",children:[formatCurrency(r)," (",getPercentage(r),"%)"]})]}),(0,s.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2",children:(0,s.jsx)("div",{className:"h-2 rounded-full ".concat(i[t%i.length]),style:{width:"".concat(getPercentage(r),"%")}})})]},a)})}),(0,s.jsx)("div",{className:"pt-4 border-t",children:(0,s.jsxs)("div",{className:"flex justify-between items-center font-semibold",children:[(0,s.jsx)("span",{children:"Total"}),(0,s.jsx)("span",{className:"text-green-600",children:formatCurrency(a)})]})})]})})]})}function ConfirmDeleteModal(e){let{isOpen:t,onClose:a,onConfirm:r,title:i,projectName:n,loading:o=!1}=e,[c,d]=(0,l.useState)("");if(!t)return null;let handleClose=()=>{d(""),a()};return(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:(0,s.jsxs)("div",{className:"bg-white rounded-lg max-w-md w-full",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between p-6 border-b",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("div",{className:"w-10 h-10 bg-red-100 rounded-full flex items-center justify-center",children:(0,s.jsx)(z.Z,{className:"h-5 w-5 text-red-600"})}),(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:i})]}),(0,s.jsx)("button",{onClick:handleClose,disabled:o,className:"text-gray-400 hover:text-gray-600 transition-colors",children:(0,s.jsx)(v.Z,{className:"h-5 w-5"})})]}),(0,s.jsxs)("div",{className:"p-6",children:[(0,s.jsxs)("div",{className:"mb-6",children:[(0,s.jsxs)("p",{className:"text-gray-600 mb-4",children:["Est\xe1s a punto de eliminar el proyecto ",(0,s.jsxs)("strong",{children:['"',n,'"']}),"."]}),(0,s.jsxs)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-4",children:[(0,s.jsx)("h4",{className:"font-medium text-red-800 mb-2",children:"Esta acci\xf3n:"}),(0,s.jsxs)("ul",{className:"text-sm text-red-700 space-y-1",children:[(0,s.jsx)("li",{children:"• Eliminar\xe1 TODOS los datos del proyecto"}),(0,s.jsx)("li",{children:"• No se puede deshacer"}),(0,s.jsx)("li",{children:"• Eliminar\xe1 ingresos, gastos e inventario"}),(0,s.jsx)("li",{children:"• Eliminar\xe1 todos los miembros del proyecto"})]})]}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsxs)("label",{htmlFor:"confirm-text",className:"block text-sm font-medium text-gray-700",children:["Para confirmar, escribe ",(0,s.jsx)("strong",{children:"ELIMINAR"})," en el campo de abajo:"]}),(0,s.jsx)(I.I,{id:"confirm-text",type:"text",value:c,onChange:e=>d(e.target.value),placeholder:"Escribe ELIMINAR",disabled:o,className:"font-mono"})]})]}),(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row gap-3 sm:justify-end",children:[(0,s.jsx)(h.z,{variant:"outline",onClick:handleClose,disabled:o,className:"sm:order-1",children:"Cancelar"}),(0,s.jsx)(h.z,{variant:"danger",onClick:()=>{"ELIMINAR"===c&&r()},disabled:"ELIMINAR"!==c||o,loading:o,className:"sm:order-2",children:o?"Eliminando...":"Eliminar Proyecto"})]})]})]})})}var eu=a(471),eg=a(9168),eh=a(9036),ep=a(7972);function ProjectMembers(e){let{projectId:t,currentUserId:a,userRole:r}=e,[i,n]=(0,l.useState)([]),[o,c]=(0,l.useState)(!0),[d,m]=(0,l.useState)(null);(0,l.useEffect)(()=>{loadMembers()},[t]);let loadMembers=async()=>{try{let e=await w.C.getProjectMembers(t);n(e)}catch(e){console.error("Error loading members:",e)}finally{c(!1)}},handleRoleChange=async(e,s,l)=>{if(!P.canManageMembers(r)){alert("No tienes permisos para cambiar roles");return}if(s===a){alert("No puedes cambiar tu propio rol");return}m(e);try{await w.C.updateMemberRole(t,s,l),await loadMembers()}catch(e){console.error("Error updating member role:",e),alert("Error al actualizar el rol del miembro")}finally{m(null)}},handleRemoveMember=async(e,s)=>{if(!P.canManageMembers(r)){alert("No tienes permisos para remover miembros");return}if(s===a){alert("No puedes removerte a ti mismo del proyecto");return}if(confirm("\xbfEst\xe1s seguro de que quieres remover este miembro del proyecto?"))try{await w.C.removeMember(t,s),await loadMembers()}catch(e){console.error("Error removing member:",e),alert("Error al remover el miembro")}},getRoleIcon=e=>{switch(e){case"owner":return(0,s.jsx)(eg.Z,{className:"h-4 w-4"});case"admin":return(0,s.jsx)(eh.Z,{className:"h-4 w-4"});case"normal":default:return(0,s.jsx)(ep.Z,{className:"h-4 w-4"});case"view":return(0,s.jsx)(M.Z,{className:"h-4 w-4"})}};return o?(0,s.jsx)(p.Zb,{children:(0,s.jsx)(p.aY,{className:"p-6",children:(0,s.jsxs)("div",{className:"animate-pulse space-y-4",children:[(0,s.jsx)("div",{className:"h-4 bg-gray-200 rounded w-1/4"}),(0,s.jsxs)("div",{className:"space-y-2",children:[(0,s.jsx)("div",{className:"h-4 bg-gray-200 rounded"}),(0,s.jsx)("div",{className:"h-4 bg-gray-200 rounded w-5/6"})]})]})})}):(0,s.jsxs)(p.Zb,{children:[(0,s.jsxs)(p.Ol,{children:[(0,s.jsxs)(p.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(x.Z,{className:"h-5 w-5"}),"Miembros del Proyecto (",i.length,")"]}),(0,s.jsx)(p.SZ,{children:"Gestiona los miembros y sus roles en el proyecto"})]}),(0,s.jsxs)(p.aY,{children:[(0,s.jsxs)("div",{className:"space-y-4",children:[i.map(e=>{var t,l,i;return(0,s.jsx)("div",{className:"p-3 sm:p-4 border border-gray-200 rounded-lg hover:bg-gray-50",children:(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[(0,s.jsxs)("div",{className:"flex items-start gap-2 sm:gap-3 min-w-0 flex-1",children:[(0,s.jsx)("div",{className:"flex-shrink-0 mt-1",children:getRoleIcon(e.role)}),(0,s.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2",children:[(0,s.jsxs)("p",{className:"font-medium text-gray-900 break-words",children:[(null===(t=e.user)||void 0===t?void 0:t.full_name)||"Sin nombre",e.user_id===a&&(0,s.jsx)("span",{className:"text-sm text-gray-500 ml-2",children:"(T\xfa)"})]}),!(null===(l=e.user)||void 0===l?void 0:l.full_name)&&(0,s.jsx)("span",{className:"text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full w-fit",children:"Sin nombre configurado"})]}),(0,s.jsx)("p",{className:"text-sm text-gray-500 break-all",children:null===(i=e.user)||void 0===i?void 0:i.email}),(0,s.jsxs)("p",{className:"text-xs text-gray-400",children:["Miembro desde: ",new Date(e.joined_at).toLocaleDateString("es-CO")]}),(0,s.jsx)("div",{className:"mt-2 sm:hidden",children:(0,s.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ".concat(P.getRoleColor(e.role)),children:P.getRoleDisplayName(e.role)})})]}),(0,s.jsx)("div",{className:"hidden sm:block",children:(0,s.jsx)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ".concat(P.getRoleColor(e.role)),children:P.getRoleDisplayName(e.role)})})]}),(0,s.jsx)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 w-full sm:w-auto",children:P.canManageMembers(r)&&e.user_id!==a&&"owner"!==e.role&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("select",{value:e.role,onChange:t=>handleRoleChange(e.id,e.user_id,t.target.value),disabled:d===e.id,className:"text-sm border border-gray-300 rounded-md px-2 py-1 bg-white w-full sm:w-auto",children:P.getAssignableRoles().map(e=>(0,s.jsx)("option",{value:e,children:P.getRoleDisplayName(e)},e))}),(0,s.jsxs)(h.z,{variant:"ghost",size:"sm",onClick:()=>handleRemoveMember(e.id,e.user_id),className:"text-red-600 hover:text-red-800 hover:bg-red-50 w-full sm:w-auto",children:[(0,s.jsx)(O.Z,{className:"h-4 w-4 mr-2 sm:mr-0"}),(0,s.jsx)("span",{className:"sm:hidden",children:"Eliminar miembro"})]})]})})]})},e.id)}),0===i.length&&(0,s.jsxs)("div",{className:"text-center py-8 text-gray-500",children:[(0,s.jsx)(x.Z,{className:"h-12 w-12 mx-auto mb-4 text-gray-300"}),(0,s.jsx)("p",{children:"No hay miembros en este proyecto"})]})]}),(0,s.jsx)("div",{className:"mt-6 pt-6 border-t border-gray-200",children:(0,s.jsxs)("div",{className:"bg-blue-50 rounded-lg p-3 sm:p-4",children:[(0,s.jsx)("h4",{className:"font-medium text-blue-900 mb-3",children:"Descripci\xf3n de Roles"}),(0,s.jsxs)("div",{className:"space-y-3 text-sm",children:[(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 flex-shrink-0",children:[(0,s.jsx)(eg.Z,{className:"h-4 w-4 text-purple-600"}),(0,s.jsx)("span",{className:"font-medium",children:"Propietario:"})]}),(0,s.jsx)("span",{className:"text-gray-600 break-words",children:"Acceso completo al proyecto"})]}),(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 flex-shrink-0",children:[(0,s.jsx)(eh.Z,{className:"h-4 w-4 text-blue-600"}),(0,s.jsx)("span",{className:"font-medium",children:"Administrador:"})]}),(0,s.jsx)("span",{className:"text-gray-600 break-words",children:"Puede hacer todo excepto eliminar el proyecto"})]}),(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 flex-shrink-0",children:[(0,s.jsx)(ep.Z,{className:"h-4 w-4 text-green-600"}),(0,s.jsx)("span",{className:"font-medium",children:"Usuario Normal:"})]}),(0,s.jsx)("span",{className:"text-gray-600 break-words",children:"Puede navegar, crear ingresos y egresos, pero no eliminar"})]}),(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 flex-shrink-0",children:[(0,s.jsx)(M.Z,{className:"h-4 w-4 text-gray-600"}),(0,s.jsx)("span",{className:"font-medium",children:"Solo Vista:"})]}),(0,s.jsx)("span",{className:"text-gray-600 break-words",children:"Solo puede ver el resumen del proyecto"})]})]})]})})]})]})}let LogbookService=class LogbookService{async getProjectEntries(e){try{let{data:t,error:a}=await y.O.from("logbook_entries").select("\n          *,\n          logbook_images (*)\n        ").eq("project_id",e).order("entry_date",{ascending:!1});if(a)throw a;let s=Array.from(new Set((null==t?void 0:t.map(e=>e.user_id))||[])),{data:r}=await y.O.from("users").select("id, full_name, email").in("id",s),l=new Map((null==r?void 0:r.map(e=>[e.id,e]))||[]);return(t||[]).map(e=>{var t,a;return{...e,images:e.logbook_images||[],user_name:(null===(t=l.get(e.user_id))||void 0===t?void 0:t.full_name)||(null===(a=l.get(e.user_id))||void 0===a?void 0:a.email)||"Usuario desconocido"}})}catch(e){throw console.error("Error fetching logbook entries:",e),e}}async getEntry(e){try{let{data:t,error:a}=await y.O.from("logbook_entries").select("\n          *,\n          logbook_images (*)\n        ").eq("id",e).single();if(a)throw a;return{...t,images:t.logbook_images||[]}}catch(e){throw console.error("Error fetching logbook entry:",e),e}}async createEntry(e){try{let{data:{user:t}}=await y.O.auth.getUser();if(!t)throw Error("Usuario no autenticado");let{data:a,error:s}=await y.O.from("logbook_entries").insert({project_id:e.project_id,user_id:t.id,title:e.title,description:e.description||null,entry_date:e.entry_date||new Date().toISOString()}).select().single();if(s)throw s;if(e.images&&e.images.length>0){let t=await this.uploadImages(a.id,e.images);a.images=t}let{data:r}=await y.O.from("users").select("id, full_name, email").eq("id",t.id).single();return a.user_name=(null==r?void 0:r.full_name)||(null==r?void 0:r.email)||"Usuario desconocido",a}catch(e){throw console.error("Error creating logbook entry:",e),e}}async updateEntry(e,t){try{let a={};void 0!==t.title&&(a.title=t.title),void 0!==t.description&&(a.description=t.description),void 0!==t.entry_date&&(a.entry_date=t.entry_date);let{error:s}=await y.O.from("logbook_entries").update(a).eq("id",e);if(s)throw s}catch(e){throw console.error("Error updating logbook entry:",e),e}}async deleteEntry(e){try{let{data:t}=await y.O.from("logbook_images").select("image_path").eq("entry_id",e),{error:a}=await y.O.from("logbook_entries").delete().eq("id",e);if(a)throw a;if(t&&t.length>0){let e=t.map(e=>e.image_path);await y.O.storage.from(this.bucketName).remove(e)}}catch(e){throw console.error("Error deleting logbook entry:",e),e}}async uploadImages(e,t){try{let{data:{user:a}}=await y.O.auth.getUser();if(!a)throw Error("Usuario no autenticado");let s=[];for(let a=0;a<t.length;a++){let r=t[a],l=r.name.split(".").pop(),i="".concat(e,"/").concat(Date.now(),"_").concat(a,".").concat(l),{error:n}=await y.O.storage.from(this.bucketName).upload(i,r,{cacheControl:"3600",upsert:!1});if(n)throw n;let{data:{publicUrl:o}}=y.O.storage.from(this.bucketName).getPublicUrl(i),{data:c,error:d}=await y.O.from("logbook_images").insert({entry_id:e,image_url:o,image_path:i,display_order:a}).select().single();if(d)throw d;s.push(c)}return s}catch(e){throw console.error("Error uploading images:",e),e}}async deleteImage(e){try{let{data:t}=await y.O.from("logbook_images").select("image_path").eq("id",e).single();if(!t)throw Error("Imagen no encontrada");let{error:a}=await y.O.from("logbook_images").delete().eq("id",e);if(a)throw a;let{error:s}=await y.O.storage.from(this.bucketName).remove([t.image_path]);if(s)throw s}catch(e){throw console.error("Error deleting image:",e),e}}async addImagesToEntry(e,t){try{let{data:a}=await y.O.from("logbook_images").select("display_order").eq("entry_id",e).order("display_order",{ascending:!1}).limit(1),s=a&&a.length>0?a[0].display_order+1:0,{data:{user:r}}=await y.O.auth.getUser();if(!r)throw Error("Usuario no autenticado");let l=[];for(let a=0;a<t.length;a++){let r=t[a],i=r.name.split(".").pop(),n="".concat(e,"/").concat(Date.now(),"_").concat(a,".").concat(i),{error:o}=await y.O.storage.from(this.bucketName).upload(n,r,{cacheControl:"3600",upsert:!1});if(o)throw o;let{data:{publicUrl:c}}=y.O.storage.from(this.bucketName).getPublicUrl(n),{data:d,error:m}=await y.O.from("logbook_images").insert({entry_id:e,image_url:c,image_path:n,display_order:s+a}).select().single();if(m)throw m;l.push(d)}return l}catch(e){throw console.error("Error adding images to entry:",e),e}}constructor(){this.bucketName="logbook-images"}};let ef=new LogbookService;var ej=a(9954);let eb=Y.Ry({title:Y.Z_().min(3,"El t\xedtulo debe tener al menos 3 caracteres"),description:Y.Z_().optional(),entry_date:Y.Z_().optional()});function AddLogbookEntryForm(e){let{projectId:t,onSuccess:a}=e,[r,i]=(0,l.useState)(!1),[n,o]=(0,l.useState)([]),[c,d]=(0,l.useState)([]),{success:m,error:x}=(0,D.useToast)(),{register:u,handleSubmit:g,formState:{errors:y},reset:N}=(0,f.cI)({resolver:(0,j.F)(eb),defaultValues:{entry_date:new Date().toISOString().split("T")[0]}}),removeImage=e=>{o(t=>t.filter((t,a)=>a!==e)),d(t=>t.filter((t,a)=>a!==e))},onSubmit=async e=>{i(!0);try{await ef.createEntry({project_id:t,title:e.title,description:e.description,entry_date:e.entry_date,images:n}),N(),o([]),d([]),a()}catch(e){console.error("Error creating logbook entry:",e),x("Error al crear la entrada de bit\xe1cora")}finally{i(!1)}};return(0,s.jsxs)(p.Zb,{children:[(0,s.jsx)(p.Ol,{children:(0,s.jsxs)(p.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(ej.Z,{className:"h-5 w-5"}),"Nueva Entrada de Bit\xe1cora"]})}),(0,s.jsx)(p.aY,{children:(0,s.jsxs)("form",{onSubmit:g(onSubmit),className:"space-y-4",children:[(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-12 gap-3 md:gap-4",children:[(0,s.jsxs)("div",{className:"md:col-span-5",children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-center mb-1",children:"T\xedtulo *"}),(0,s.jsx)("input",{type:"text",...u("title"),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-transparent text-center",placeholder:"Ej: Avance en construcci\xf3n"}),y.title&&(0,s.jsx)("p",{className:"text-red-600 text-sm mt-1 text-center",children:y.title.message})]}),(0,s.jsxs)("div",{className:"md:col-span-3",children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-center mb-1",children:"Fecha"}),(0,s.jsx)("input",{type:"date",...u("entry_date"),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-transparent text-center",style:{paddingLeft:"40px",paddingRight:"40px"}})]}),(0,s.jsxs)("div",{className:"md:col-span-4",children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-center mb-1",children:"Im\xe1genes (Opcional)"}),(0,s.jsx)("input",{id:"logbook-images",type:"file",accept:"image/*",multiple:!0,onChange:e=>{let t=Array.from(e.target.files||[]);if(0===t.length)return;let a=t.filter(e=>{let t=e.type.startsWith("image/");return t||x("".concat(e.name," no es una imagen v\xe1lida")),t}),s=[];a.forEach(e=>{let t=new FileReader;t.onloadend=()=>{s.push(t.result),s.length===a.length&&d(e=>[...e,...s])},t.readAsDataURL(e)}),o(e=>[...e,...a])},className:"hidden"}),(0,s.jsxs)(h.z,{type:"button",variant:"outline",className:"w-full",onClick:()=>{var e;return null===(e=document.getElementById("logbook-images"))||void 0===e?void 0:e.click()},children:[(0,s.jsx)(b.Z,{className:"h-4 w-4 mr-2"}),n.length>0?"".concat(n.length," seleccionada(s)"):"Seleccionar Im\xe1genes"]})]})]}),c.length>0&&(0,s.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3",children:c.map((e,t)=>(0,s.jsxs)("div",{className:"relative group",children:[(0,s.jsx)("img",{src:e,alt:"Preview ".concat(t+1),className:"w-full h-24 sm:h-28 object-contain rounded-lg border-2 border-gray-200 bg-gray-50"}),(0,s.jsx)("button",{type:"button",onClick:()=>removeImage(t),className:"absolute top-1 right-1 bg-red-500 text-white p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-lg",children:(0,s.jsx)(v.Z,{className:"h-3 w-3 sm:h-4 sm:w-4"})})]},t))}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-center mb-1",children:"Descripci\xf3n (Opcional)"}),(0,s.jsx)("textarea",{...u("description"),rows:4,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none text-center",placeholder:"Describe los avances, observaciones o detalles importantes..."})]}),(0,s.jsx)(h.z,{type:"submit",loading:r,disabled:r,className:"w-full",children:r?"Guardando...":"Guardar Entrada"})]})})]})}var ev=a(9224);function LogbookList(e){let{entries:t,currentUserId:a,userRole:r,onUpdate:i}=e,[n,o]=(0,l.useState)(null),[c,d]=(0,l.useState)(null),[m,x]=(0,l.useState)(null),{success:u,error:g}=(0,D.useToast)(),f=useConfirm(),handleDelete=async e=>{let t=await f.confirm({title:"Eliminar Entrada de Bit\xe1cora",message:"\xbfEst\xe1s seguro de que deseas eliminar esta entrada? Esta acci\xf3n no se puede deshacer.",confirmText:"Eliminar",cancelText:"Cancelar",variant:"danger"});if(t){d(e);try{await ef.deleteEntry(e),u("Entrada eliminada exitosamente"),i()}catch(e){console.error("Error deleting entry:",e),g("Error al eliminar la entrada")}finally{d(null)}}},toggleExpand=e=>{o(n===e?null:e)},formatDate=e=>{let t=new Date(e);return t.toLocaleDateString("es-ES",{year:"numeric",month:"long",day:"numeric"})},canDelete=e=>e.user_id===a||P.canManageProject(r);return 0===t.length?(0,s.jsx)(p.Zb,{children:(0,s.jsx)(p.aY,{className:"py-12",children:(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center text-gray-500",children:[(0,s.jsx)($.Z,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),(0,s.jsx)("p",{className:"text-lg font-medium",children:"No hay entradas en la bit\xe1cora"}),(0,s.jsx)("p",{className:"text-sm mt-1",children:"Comienza a documentar el progreso del proyecto"})]})})}):(0,s.jsxs)("div",{className:"space-y-4",children:[t.map(e=>{let t=n===e.id,a=e.images&&e.images.length>0;return(0,s.jsx)(p.Zb,{className:"overflow-hidden",children:(0,s.jsxs)(p.aY,{className:"p-4 sm:p-6",children:[(0,s.jsxs)("div",{className:"flex items-start justify-between gap-3 mb-3",children:[(0,s.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-gray-900 break-words",children:e.title}),(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-3 mt-2 text-sm text-gray-600",children:[(0,s.jsxs)("span",{className:"flex items-center gap-1",children:[(0,s.jsx)(q.Z,{className:"h-4 w-4"}),formatDate(e.entry_date)]}),(0,s.jsxs)("span",{className:"flex items-center gap-1",children:[(0,s.jsx)(ep.Z,{className:"h-4 w-4"}),e.user_name]}),a&&(0,s.jsxs)("span",{className:"flex items-center gap-1 text-primary-600",children:[(0,s.jsx)($.Z,{className:"h-4 w-4"}),e.images.length," imagen(es)"]})]})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2 flex-shrink-0",children:[a&&(0,s.jsx)(h.z,{variant:"ghost",size:"sm",onClick:()=>toggleExpand(e.id),children:t?(0,s.jsx)(ev.Z,{className:"h-4 w-4"}):(0,s.jsx)(K.Z,{className:"h-4 w-4"})}),canDelete(e)&&(0,s.jsx)(h.z,{variant:"ghost",size:"sm",onClick:()=>handleDelete(e.id),disabled:c===e.id,className:"text-red-600 hover:text-red-700 hover:bg-red-50",children:(0,s.jsx)(O.Z,{className:"h-4 w-4"})})]})]}),e.description&&(0,s.jsx)("div",{className:"mt-3 text-gray-700 whitespace-pre-wrap",children:e.description}),a&&t&&(0,s.jsx)("div",{className:"mt-4 pt-4 border-t border-gray-200",children:(0,s.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3",children:e.images.map(e=>(0,s.jsxs)("div",{className:"relative group cursor-pointer",onClick:()=>x(e.image_url),children:[(0,s.jsx)("img",{src:e.image_url,alt:e.caption||"Imagen de bit\xe1cora",className:"w-full h-32 object-contain rounded-lg border-2 border-gray-200 hover:border-primary-500 transition-colors bg-gray-50"}),(0,s.jsx)("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-opacity rounded-lg flex items-center justify-center",children:(0,s.jsx)($.Z,{className:"h-6 w-6 text-white opacity-0 group-hover:opacity-100 transition-opacity"})})]},e.id))})})]})},e.id)}),m&&(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4",onClick:()=>x(null),children:(0,s.jsxs)("div",{className:"relative max-w-4xl max-h-full",children:[(0,s.jsx)("img",{src:m,alt:"Imagen ampliada",className:"max-w-full max-h-[90vh] object-contain rounded-lg"}),(0,s.jsx)("button",{onClick:()=>x(null),className:"absolute top-2 right-2 bg-white text-gray-900 p-2 rounded-full hover:bg-gray-100",children:(0,s.jsx)("svg",{className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]})}),(0,s.jsx)(ConfirmModal,{isOpen:f.isOpen,onClose:f.handleCancel,onConfirm:f.handleConfirm,title:f.options.title,message:f.options.message,confirmText:f.options.confirmText,cancelText:f.options.cancelText,variant:f.options.variant})]})}function ProjectPageClient(e){var t;let{projectId:a,initialTab:f}=e,j=(0,r.useRouter)(),{success:b}=(0,D.useToast)(),[v,y]=(0,l.useState)(null),[_,C]=(0,l.useState)([]),[k,E]=(0,l.useState)([]),[S,I]=(0,l.useState)([]),[O,z]=(0,l.useState)([]),[U,Z]=(0,l.useState)(null),[q,T]=(0,l.useState)(null),[M,A]=(0,l.useState)("view"),[R,V]=(0,l.useState)(!1),[L,B]=(0,l.useState)(!1),[Y,W]=(0,l.useState)(!0),[Q,$]=(0,l.useState)(f||"overview"),[K,H]=(0,l.useState)(!1),[J,X]=(0,l.useState)(!1),[ee,et]=(0,l.useState)(!1),[ea,es]=(0,l.useState)(!1);(0,l.useEffect)(()=>{let handleSettingsToggle=()=>{handleTabChange("settings")};return window.addEventListener("toggleProjectSettings",handleSettingsToggle),()=>window.removeEventListener("toggleProjectSettings",handleSettingsToggle)},[Q]);let handleTabChange=e=>{Q===e?$("overview"):$(e),H(!1),X(!1),et(!1)},confirmDeleteProject=async()=>{V(!0);try{await w.C.deleteProject(a),B(!1),alert("Proyecto eliminado exitosamente"),j.push("/dashboard")}catch(e){console.error("Error al eliminar proyecto:",e),alert("Error al eliminar el proyecto. Por favor, intenta de nuevo.")}finally{V(!1)}};(0,l.useEffect)(()=>{let loadData=async()=>{try{let{user:e}=await eu.I.getCurrentUser();if(!e){j.push("/auth/login");return}Z(e);let[t,s,r,l]=await Promise.all([w.C.getProject(a),N.getProjectIncome(a),F.getProjectExpenses(a),w.C.getUserRole(a,e.id)]),i=await G.getItemsWithQuantities(a),n=await ef.getProjectEntries(a);y(t),C(s),E(r),I(i),z(n),A(l)}catch(e){console.error("Error loading project data:",e)}finally{W(!1)}};a&&loadData()},[a]);let handleIncomeUpdate=async()=>{try{let e=await N.getProjectIncome(a);C(e),H(!1),b("✅ Ingreso agregado exitosamente")}catch(e){console.error("Error updating income:",e)}},handleExpenseUpdate=async()=>{try{let e=await F.getProjectExpenses(a);E(e),X(!1),b("✅ Gasto agregado exitosamente")}catch(e){console.error("Error updating expenses:",e)}},handleLogbookUpdate=async()=>{try{let e=await ef.getProjectEntries(a);z(e),et(!1),b("✅ Entrada de bit\xe1cora agregada exitosamente")}catch(e){console.error("Error updating logbook entries:",e)}};if(Y)return(0,s.jsx)("div",{className:"flex items-center justify-center min-h-[400px]",children:(0,s.jsx)("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-primary"})});if(!v)return(0,s.jsxs)("div",{className:"text-center py-12",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold text-gray-900",children:"Proyecto no encontrado"}),(0,s.jsx)("p",{className:"text-gray-600 mt-2",children:"El proyecto que buscas no existe o no tienes acceso a \xe9l."})]});let er=_.filter(e=>"approved"===e.status).reduce((e,t)=>e+t.amount,0),el=k.reduce((e,t)=>e+t.amount,0),ei=er-el,formatAmount=e=>{let t=(null==v?void 0:v.currency)||"COP";return formatCurrency(e,t)};return(0,s.jsxs)("div",{className:"min-h-screen bg-gradient-to-br from-primary-50 to-accent-50 px-2 sm:px-4 lg:px-8 py-4 sm:py-8",children:[(0,s.jsxs)("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-lg p-4 sm:p-6 mb-4 sm:mb-6",children:[(0,s.jsx)("div",{className:"flex items-center gap-3 mb-4",children:(0,s.jsxs)(h.z,{variant:"ghost",size:"sm",onClick:()=>j.push("/dashboard"),className:"text-primary-600 hover:text-primary-800",children:[(0,s.jsx)(i.Z,{className:"h-4 w-4 mr-1"}),"Volver a Proyectos"]})}),(0,s.jsx)("div",{className:"mb-4 sm:mb-6",children:(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3",children:[(0,s.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,s.jsx)("h1",{className:"text-2xl sm:text-3xl font-bold text-primary-800 mb-2 break-words",children:v.name}),v.description&&(0,s.jsx)("p",{className:"text-primary-600 mb-3 text-sm sm:text-base",children:v.description}),(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row sm:flex-wrap sm:items-center gap-2 sm:gap-4 text-xs sm:text-sm text-primary-500",children:[(0,s.jsxs)("span",{className:"flex items-center",children:["C\xf3digo: ",(0,s.jsx)("span",{className:"font-mono bg-primary-100 px-2 py-1 rounded ml-1 text-xs",children:v.invite_code})]}),(0,s.jsxs)("span",{children:["Moneda: ",(0,s.jsx)("span",{className:"font-semibold",children:(null==v?void 0:v.currency)||"COP"})]}),(0,s.jsxs)("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ".concat(P.getRoleColor(M)," w-fit"),children:["Tu rol: ",P.getRoleDisplayName(M)]})]})]}),(0,s.jsx)("div",{className:"flex items-center gap-2"})]})}),(0,s.jsx)("div",{className:"border-b border-gray-200 overflow-hidden",children:(0,s.jsxs)("nav",{className:"-mb-px flex space-x-2 sm:space-x-4 lg:space-x-8 overflow-x-auto scrollbar-hide px-1",children:[(0,s.jsxs)("button",{onClick:()=>handleTabChange("overview"),className:"py-3 px-2 sm:px-3 border-b-2 font-medium text-xs sm:text-sm whitespace-nowrap flex-shrink-0 ".concat("overview"===Q?"border-primary-500 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[(0,s.jsx)(n.Z,{className:"h-4 w-4 inline mr-1 sm:mr-2"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:"Resumen"}),(0,s.jsx)("span",{className:"sm:hidden",children:"Inicio"})]}),P.canEdit(M)&&(0,s.jsxs)("button",{onClick:()=>handleTabChange("income"),className:"py-3 px-2 sm:px-3 border-b-2 font-medium text-xs sm:text-sm whitespace-nowrap flex-shrink-0 ".concat("income"===Q?"border-primary-500 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[(0,s.jsx)(o.Z,{className:"h-4 w-4 inline mr-1 sm:mr-2"}),(0,s.jsxs)("span",{className:"hidden sm:inline",children:["Ingresos (",_.length,")"]}),(0,s.jsx)("span",{className:"sm:hidden",children:"Ingresos"})]}),P.canEdit(M)&&(0,s.jsxs)("button",{onClick:()=>handleTabChange("expenses"),className:"py-3 px-2 sm:px-3 border-b-2 font-medium text-xs sm:text-sm whitespace-nowrap flex-shrink-0 ".concat("expenses"===Q?"border-primary-500 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[(0,s.jsx)(c.Z,{className:"h-4 w-4 inline mr-1 sm:mr-2"}),(0,s.jsxs)("span",{className:"hidden sm:inline",children:["Gastos (",k.length,")"]}),(0,s.jsx)("span",{className:"sm:hidden",children:"Gastos"})]}),P.canEdit(M)&&(0,s.jsxs)("button",{onClick:()=>handleTabChange("inventory"),className:"py-3 px-2 sm:px-3 border-b-2 font-medium text-xs sm:text-sm whitespace-nowrap flex-shrink-0 ".concat("inventory"===Q?"border-primary-500 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[(0,s.jsx)(d.Z,{className:"h-4 w-4 inline mr-1 sm:mr-2"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:"Inventario"}),(0,s.jsx)("span",{className:"sm:hidden",children:"Stock"})]}),(0,s.jsxs)("button",{onClick:()=>handleTabChange("logbook"),className:"py-3 px-2 sm:px-3 border-b-2 font-medium text-xs sm:text-sm whitespace-nowrap flex-shrink-0 ".concat("logbook"===Q?"border-primary-500 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[(0,s.jsx)(m.Z,{className:"h-4 w-4 inline mr-1 sm:mr-2"}),(0,s.jsxs)("span",{className:"hidden sm:inline",children:["Bit\xe1cora (",O.length,")"]}),(0,s.jsx)("span",{className:"sm:hidden",children:"Bit\xe1cora"})]}),P.canManageMembers(M)&&(0,s.jsxs)("button",{onClick:()=>handleTabChange("members"),className:"py-3 px-2 sm:px-3 border-b-2 font-medium text-xs sm:text-sm whitespace-nowrap flex-shrink-0 ".concat("members"===Q?"border-primary-500 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[(0,s.jsx)(x.Z,{className:"h-4 w-4 inline mr-1 sm:mr-2"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:"Miembros"}),(0,s.jsx)("span",{className:"sm:hidden",children:"Equipo"})]}),P.canManageProject(M)&&(0,s.jsxs)("button",{onClick:()=>handleTabChange("settings"),className:"py-3 px-2 sm:px-3 border-b-2 font-medium text-xs sm:text-sm whitespace-nowrap flex-shrink-0 ".concat("settings"===Q?"border-primary-500 text-primary-600":"border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300"),children:[(0,s.jsx)(u.Z,{className:"h-4 w-4 inline mr-1 sm:mr-2"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:"Configuraci\xf3n"}),(0,s.jsx)("span",{className:"sm:hidden",children:"Config"})]})]})})]}),!1,(0,s.jsxs)("div",{children:["overview"===Q&&(0,s.jsxs)("div",{className:"space-y-6",children:[K&&(0,s.jsx)(AddIncomeForm,{projectId:a,onSuccess:handleIncomeUpdate}),J&&(0,s.jsx)(AddExpenseForm,{projectId:a,onSuccess:handleExpenseUpdate}),("admin"===M||"owner"===M)&&(0,s.jsxs)("div",{className:"grid gap-4 sm:gap-6 mb-4 sm:mb-6 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3",children:[(0,s.jsxs)(p.Zb,{children:[(0,s.jsx)(p.Ol,{className:"pb-2",children:(0,s.jsx)(p.ll,{className:"text-sm font-medium text-gray-600",children:"Ingresos Totales"})}),(0,s.jsxs)(p.aY,{children:[(0,s.jsx)("div",{className:"text-2xl font-bold text-green-600",children:formatAmount(er)}),(0,s.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:[_.length," ingresos"]})]})]}),(0,s.jsxs)(p.Zb,{children:[(0,s.jsx)(p.Ol,{className:"pb-2",children:(0,s.jsx)(p.ll,{className:"text-sm font-medium text-gray-600",children:"Gastos Totales"})}),(0,s.jsxs)(p.aY,{children:[(0,s.jsx)("div",{className:"text-2xl font-bold text-red-600",children:formatCurrency(el)}),(0,s.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:[k.length," gastos"]})]})]}),(0,s.jsxs)(p.Zb,{children:[(0,s.jsx)(p.Ol,{className:"pb-2",children:(0,s.jsx)(p.ll,{className:"text-sm font-medium text-gray-600",children:"Balance Final"})}),(0,s.jsxs)(p.aY,{children:[(0,s.jsx)("div",{className:"text-2xl font-bold ".concat(ei>=0?"text-green-600":"text-red-600"),children:formatAmount(ei)}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:ei>=0?"Disponible":"D\xe9ficit"})]})]})]}),(0,s.jsxs)("div",{className:"grid gap-4 sm:gap-6 ".concat("view"===M?"grid-cols-1":"grid-cols-1 lg:grid-cols-2"),children:[(0,s.jsx)(IncomeChart,{income:_,totalIncome:er}),(0,s.jsx)(ExpenseChart,{expenses:k,totalExpenses:el})]}),S.length>0&&(0,s.jsx)("div",{className:"mt-6",children:(0,s.jsx)(InventoryChart,{items:S,showSummary:!1})})]}),"income"===Q&&(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsx)("h2",{className:"text-lg font-medium",children:"Gesti\xf3n de Ingresos"}),P.canEdit(M)&&(0,s.jsxs)(h.z,{onClick:()=>H(!K),children:[(0,s.jsx)(g.Z,{className:"h-4 w-4 mr-2"}),K?"Cancelar":"Agregar Ingreso"]})]}),K&&(0,s.jsx)(AddIncomeForm,{projectId:a,onSuccess:handleIncomeUpdate}),(0,s.jsx)(IncomeList,{income:_,currentUserId:(null==U?void 0:U.id)||"",userRole:M,onUpdate:handleIncomeUpdate})]}),"expenses"===Q&&(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsx)("h2",{className:"text-lg font-medium",children:"Gesti\xf3n de Gastos"}),P.canEdit(M)&&(0,s.jsxs)(h.z,{onClick:()=>X(!J),children:[(0,s.jsx)(g.Z,{className:"h-4 w-4 mr-2"}),J?"Cancelar":"Agregar Gasto"]})]}),J&&(0,s.jsx)(AddExpenseForm,{projectId:a,onSuccess:handleExpenseUpdate}),(0,s.jsx)(ExpensesList,{expenses:k,currentUserId:(null==U?void 0:U.id)||"",userRole:M,onUpdate:handleExpenseUpdate})]}),"inventory"===Q&&(0,s.jsx)("div",{className:"space-y-6",children:(0,s.jsx)(InventoryTab,{projectId:a,userRole:M})}),"logbook"===Q&&(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center",children:[(0,s.jsx)("h2",{className:"text-lg font-medium",children:"Bit\xe1cora del Proyecto"}),(0,s.jsxs)(h.z,{onClick:()=>et(!ee),children:[(0,s.jsx)(g.Z,{className:"h-4 w-4 mr-2"}),ee?"Cancelar":"Nueva Entrada"]})]}),ee&&(0,s.jsx)(AddLogbookEntryForm,{projectId:a,onSuccess:handleLogbookUpdate}),(0,s.jsx)(LogbookList,{entries:O,currentUserId:(null==U?void 0:U.id)||"",userRole:M,onUpdate:handleLogbookUpdate})]}),"members"===Q&&(0,s.jsx)("div",{className:"space-y-6",children:(0,s.jsx)(ProjectMembers,{projectId:a,currentUserId:(null==U?void 0:U.id)||"",userRole:M})}),"settings"===Q&&(0,s.jsx)("div",{className:"space-y-6",children:(0,s.jsxs)(p.Zb,{children:[(0,s.jsxs)(p.Ol,{children:[(0,s.jsxs)(p.ll,{className:"flex items-center gap-2",children:[(0,s.jsx)(u.Z,{className:"h-5 w-5"}),"Configuraci\xf3n del Proyecto"]}),(0,s.jsx)(p.SZ,{children:"Administra la configuraci\xf3n y opciones del proyecto"})]}),(0,s.jsxs)(p.aY,{className:"space-y-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-lg font-medium mb-4",children:"Informaci\xf3n General"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Nombre del Proyecto"}),(0,s.jsx)("div",{className:"p-3 bg-gray-50 rounded-md",children:null==v?void 0:v.name})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"C\xf3digo de Invitaci\xf3n"}),(0,s.jsx)("div",{className:"p-3 bg-gray-50 rounded-md font-mono",children:null==v?void 0:v.invite_code})]})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-lg font-medium mb-4",children:"Configuraci\xf3n de Moneda"}),(0,s.jsx)("div",{className:"space-y-4",children:(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Moneda Actual"}),(0,s.jsxs)("div",{className:"flex items-center gap-4",children:[(0,s.jsx)("div",{className:"p-3 bg-primary-50 rounded-md font-semibold text-primary-700",children:(null==v?void 0:v.currency)==="COP"?"Peso Colombiano (COP)":"D\xf3lar Australiano (AUD)"}),(0,s.jsxs)(h.z,{variant:"outline",size:"sm",onClick:()=>{let e=(null==v?void 0:v.currency)==="COP"?"AUD":"COP";alert("Funci\xf3n pendiente: Cambiar a ".concat(e))},children:["Cambiar a ",(null==v?void 0:v.currency)==="COP"?"AUD":"COP"]})]}),(0,s.jsx)("p",{className:"text-sm text-gray-500 mt-2",children:"Cambiar la moneda afectar\xe1 c\xf3mo se muestran los montos en el proyecto"})]})})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-lg font-medium mb-4 text-red-600",children:"Zona de Peligro"}),(0,s.jsxs)("div",{className:"border border-red-200 rounded-lg p-4 bg-red-50",children:[(0,s.jsx)("p",{className:"text-sm text-red-700 mb-4",children:"Las siguientes acciones son irreversibles y eliminar\xe1n permanentemente los datos."}),(0,s.jsx)(h.z,{variant:"danger",size:"sm",onClick:()=>{if(!P.canManageProject(M)){alert("No tienes permisos para eliminar este proyecto");return}B(!0)},loading:R,disabled:R,children:R?"Eliminando...":"Eliminar Proyecto"})]})]})]})]})})]}),(0,s.jsx)(em.m,{isOpen:ea,onClose:()=>es(!1),currentEmail:(null==U?void 0:U.email)||"",currentFullName:(null==U?void 0:null===(t=U.user_metadata)||void 0===t?void 0:t.full_name)||"",onUpdated:()=>{eu.I.getCurrentUser().then(e=>{let{user:t}=e;t&&Z(t)})}}),(0,s.jsx)(ConfirmDeleteModal,{isOpen:L,onClose:()=>B(!1),onConfirm:confirmDeleteProject,title:"Eliminar Proyecto",projectName:(null==v?void 0:v.name)||"",loading:R})]})}function ProjectPageByQuery(){let e=(0,r.useSearchParams)(),t=(0,r.useRouter)(),a=e.get("id")||"",l=e.get("tab")||void 0;return a?(0,s.jsx)(ProjectPageClient,{projectId:a,initialTab:l}):(0,s.jsx)("div",{className:"min-h-screen flex items-center justify-center p-6",children:(0,s.jsxs)("div",{className:"text-center space-y-4",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold",children:'Falta el par\xe1metro "id"'}),(0,s.jsx)("p",{className:"text-gray-600",children:"Debes acceder a esta p\xe1gina con ?id=PROJECT_ID"}),(0,s.jsx)("div",{children:(0,s.jsx)(h.z,{onClick:()=>t.push("/dashboard"),children:"Volver al Dashboard"})})]})})}},5546:function(e,t,a){"use strict";a.d(t,{m:function(){return AccountSettingsModal}});var s=a(7437),r=a(2265),l=a(2549),i=a(6806),n=a(9310),o=a(471);function AccountSettingsModal(e){let{isOpen:t,onClose:a,currentEmail:c,currentFullName:d,onUpdated:m}=e,[x,u]=(0,r.useState)(d||""),[g,h]=(0,r.useState)(c),[p,f]=(0,r.useState)(""),[j,b]=(0,r.useState)(""),[v,y]=(0,r.useState)(!1),[N,w]=(0,r.useState)(!1),[_,C]=(0,r.useState)(!1),[k,E]=(0,r.useState)(null),[S,I]=(0,r.useState)(null);if(!t)return null;let handleUpdateName=async()=>{if(E(null),I(null),!x.trim()){I("El nombre no puede estar vac\xedo");return}y(!0);let{error:e}=await o.I.updateFullName(x.trim());y(!1),e?I(e.message||"Error al actualizar el nombre"):(E("Nombre actualizado correctamente"),null==m||m())},handleUpdateEmail=async()=>{if(E(null),I(null),!g.trim()||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(g)){I("Ingresa un email v\xe1lido");return}if(g.trim()===c){I("El nuevo email debe ser diferente al actual");return}w(!0);let{error:e}=await o.I.updateEmail(g.trim());if(w(!1),e){var t,a;(null===(t=e.message)||void 0===t?void 0:t.includes("already registered"))?I("Este email ya est\xe1 registrado por otro usuario"):(null===(a=e.message)||void 0===a?void 0:a.includes("rate limit"))?I("Demasiados intentos. Espera unos minutos antes de intentar de nuevo"):I(e.message||"Error al actualizar el email")}else E("Se ha enviado un email de confirmaci\xf3n. Revisa tu bandeja de entrada y confirma el cambio antes de que tome efecto."),null==m||m()},handleUpdatePassword=async()=>{if(E(null),I(null),p.length<6){I("La contrase\xf1a debe tener al menos 6 caracteres");return}if(p!==j){I("Las contrase\xf1as no coinciden");return}C(!0);let{error:e}=await o.I.updatePassword(p);C(!1),e?I(e.message||"Error al actualizar la contrase\xf1a"):(E("Contrase\xf1a actualizada correctamente"),f(""),b(""))};return(0,s.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60",children:(0,s.jsxs)("div",{className:"relative w-full max-w-2xl bg-white rounded-lg shadow-xl",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between p-4 border-b",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold",children:"Ajustes de Cuenta"}),(0,s.jsx)(i.z,{variant:"ghost",size:"sm",onClick:a,children:(0,s.jsx)(l.Z,{className:"h-4 w-4"})})]}),(0,s.jsxs)("div",{className:"p-6 space-y-6",children:[S&&(0,s.jsx)("div",{className:"p-3 text-sm text-destructive bg-destructive/10 border border-destructive/20 rounded-md",children:S}),k&&(0,s.jsx)("div",{className:"p-3 text-sm text-green-700 bg-green-50 border border-green-200 rounded-md",children:k}),(0,s.jsxs)("section",{children:[(0,s.jsx)("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"Editar nombre"}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(n.I,{value:x,onChange:e=>u(e.target.value),placeholder:"Tu nombre"}),(0,s.jsx)(i.z,{onClick:handleUpdateName,loading:v,children:"Guardar"})]})]}),(0,s.jsxs)("section",{children:[(0,s.jsx)("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"Cambiar email"}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)(n.I,{value:g,onChange:e=>h(e.target.value),placeholder:"tu@correo.com"}),(0,s.jsx)(i.z,{onClick:handleUpdateEmail,loading:N,children:"Guardar"})]}),(0,s.jsxs)("p",{className:"text-xs text-gray-500 mt-1",children:[(0,s.jsx)("strong",{children:"Importante:"})," Se enviar\xe1 un email de confirmaci\xf3n. El cambio no ser\xe1 efectivo hasta que confirmes desde tu correo."]})]}),(0,s.jsxs)("section",{children:[(0,s.jsx)("h4",{className:"text-sm font-medium text-gray-700 mb-2",children:"Cambiar contrase\xf1a"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[(0,s.jsx)(n.I,{type:"password",value:p,onChange:e=>f(e.target.value),placeholder:"Nueva contrase\xf1a"}),(0,s.jsx)(n.I,{type:"password",value:j,onChange:e=>b(e.target.value),placeholder:"Confirmar contrase\xf1a"})]}),(0,s.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:"M\xednimo 6 caracteres"}),(0,s.jsx)("div",{className:"mt-2",children:(0,s.jsx)(i.z,{onClick:handleUpdatePassword,loading:_,children:"Actualizar contrase\xf1a"})})]})]})]})})}},4018:function(e,t,a){"use strict";a.r(t),a.d(t,{Toast:function(){return Toast},ToastManager:function(){return ToastManager},ToastProvider:function(){return ToastProvider},useToast:function(){return useToast}});var s=a(7437),r=a(2265),l=a(4887),i=a(3008),n=a(2104),o=a(1981),c=a(4056),d=a(2549);function Toast(e){let{message:t,type:a,duration:l=5e3,onClose:m}=e;return(0,r.useEffect)(()=>{let e=setTimeout(()=>{m()},l);return()=>clearTimeout(e)},[l,m]),(0,s.jsxs)("div",{className:"flex items-center gap-3 p-4 rounded-lg border shadow-lg ".concat((()=>{switch(a){case"success":return"bg-green-50 border-green-200";case"error":return"bg-red-50 border-red-200";case"warning":return"bg-yellow-50 border-yellow-200";case"info":return"bg-blue-50 border-blue-200"}})()," animate-in fade-in-0 zoom-in-95 duration-300"),children:[(()=>{switch(a){case"success":return(0,s.jsx)(i.Z,{className:"h-5 w-5 text-green-500"});case"error":return(0,s.jsx)(n.Z,{className:"h-5 w-5 text-red-500"});case"warning":return(0,s.jsx)(o.Z,{className:"h-5 w-5 text-yellow-500"});case"info":return(0,s.jsx)(c.Z,{className:"h-5 w-5 text-blue-500"})}})(),(0,s.jsx)("p",{className:"flex-1 text-sm font-medium text-gray-900",children:t}),(0,s.jsx)("button",{onClick:m,className:"text-gray-400 hover:text-gray-600 transition-colors",children:(0,s.jsx)(d.Z,{className:"h-4 w-4"})})]})}function ToastManager(e){let{toasts:t,removeToast:a}=e,[i,n]=(0,r.useState)(!1);return((0,r.useEffect)(()=>{n(!0)},[]),i)?(0,l.createPortal)((0,s.jsx)("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center pointer-events-none px-4",children:(0,s.jsx)("div",{className:"w-full max-w-md space-y-3 pointer-events-auto",children:t.map(e=>(0,s.jsx)(Toast,{message:e.message,type:e.type,duration:e.duration,onClose:()=>a(e.id)},e.id))})}),document.body):null}let m=(0,r.createContext)(void 0);function ToastProvider(e){let{children:t}=e,[a,l]=(0,r.useState)([]),addToast=(e,t,a)=>{let s=Math.random().toString(36).slice(2,11);l(r=>[...r,{id:s,message:e,type:t,duration:null!=a?a:5e3}])},removeToast=e=>{l(t=>t.filter(t=>t.id!==e))};return(0,s.jsxs)(m.Provider,{value:{toasts:a,removeToast,success:(e,t)=>addToast(e,"success",t),error:(e,t)=>addToast(e,"error",t),warning:(e,t)=>addToast(e,"warning",t),info:(e,t)=>addToast(e,"info",t)},children:[t,(0,s.jsx)(ToastManager,{toasts:a,removeToast:removeToast})]})}function useToast(){let e=(0,r.useContext)(m);return e||{toasts:[],removeToast:()=>{},success:()=>{},error:()=>{},warning:()=>{},info:()=>{}}}}},function(e){e.O(0,[218,727,791,20,971,472,744],function(){return e(e.s=7459)}),_N_E=e.O()}]);